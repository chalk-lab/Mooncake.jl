<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mooncake.jl · Mooncake.jl</title><meta name="title" content="Mooncake.jl · Mooncake.jl"/><meta property="og:title" content="Mooncake.jl · Mooncake.jl"/><meta property="twitter:title" content="Mooncake.jl · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href>Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>Mooncake.jl</a><ul class="internal"><li><a class="tocitem" href="#Getting-Started"><span>Getting Started</span></a></li><li><a class="tocitem" href="#Project-Goals"><span>Project Goals</span></a></li><li><a class="tocitem" href="#Project-Name"><span>Project Name</span></a></li><li><a class="tocitem" href="#Project-Status"><span>Project Status</span></a></li></ul></li><li><a class="tocitem" href="tutorial/">Tutorial</a></li><li><a class="tocitem" href="interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="developer_documentation/running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="developer_documentation/developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="developer_documentation/forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="developer_documentation/misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="developer_documentation/internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Mooncake.jl</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Mooncake.jl</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl/blob/main/docs/src/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Mooncake.jl"><a class="docs-heading-anchor" href="#Mooncake.jl">Mooncake.jl</a><a id="Mooncake.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Mooncake.jl" title="Permalink"></a></h1><p>Documentation for Mooncake.jl is on its way!</p><details class="admonition is-details"><summary class="admonition-header">Documentation Updates</summary><div class="admonition-body"><p>Note (03/10/2024): Various bits of utility functionality are now carefully documented. This includes how to change the code which Mooncake sees, declare that the derivative of a function is zero, make use of existing <code>ChainRules.rrule</code>s to quicky create new rules in Mooncake, and more.</p><p>Note (02/07/2024): The first round of documentation has arrived. This is largely targetted at those who are interested in contributing to Mooncake.jl – you can find this work in the &quot;Understanding Mooncake.jl&quot; section of the docs. There is more to to do, but it should be sufficient to understand how AD works in principle, and the core abstractions underlying Mooncake.jl.</p><p>Note (29/05/2024): I (Will) am currently actively working on the documentation. It will be merged in chunks over the next month or so as good first drafts of sections are completed. Please don&#39;t be alarmed that not all of it is here!</p></div></details><h2 id="Getting-Started"><a class="docs-heading-anchor" href="#Getting-Started">Getting Started</a><a id="Getting-Started-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-Started" title="Permalink"></a></h2><p>Check that you&#39;re running a version of Julia that Mooncake.jl supports. See the <a href="https://github.com/compintell/Mooncake.jl/blob/main/SUPPORT_POLICY.md"><code>SUPPORT_POLICY.md</code></a> for more info.</p><p>There are several ways to interact with <code>Mooncake.jl</code>. The way that we recommend people to interact with <code>Mooncake.jl</code> is via  <a href="https://github.com/gdalle/DifferentiationInterface.jl/"><code>DifferentiationInterface.jl</code></a>. For example, use it as follows to compute the gradient of a function mapping a <code>Vector{Float64}</code> to <code>Float64</code>.</p><pre><code class="language-julia hljs">using DifferentiationInterface
import Mooncake

f(x) = sum(cos, x)
backend = AutoMooncake(; config=nothing)
x = ones(1_000)
prep = prepare_gradient(f, backend, x)
gradient(f, prep, backend, x)</code></pre><p>You should expect that <code>prepare_gradient</code> takes a little bit of time to run, but that <code>gradient</code> is fast.</p><p>We are committed to ensuring support for DifferentiationInterface, which is why we recommend using that. If you are interested in interacting in a more direct fashion with <code>Mooncake.jl</code>, you should consider <code>Mooncake.value_and_gradient!!</code>. See its docstring for more info.</p><h2 id="Project-Goals"><a class="docs-heading-anchor" href="#Project-Goals">Project Goals</a><a id="Project-Goals-1"></a><a class="docs-heading-anchor-permalink" href="#Project-Goals" title="Permalink"></a></h2><p>Below the four central objectives of this project are outlined, and the approaches that we take to achieve them.</p><h3 id="Coverage-of-more-of-the-Language"><a class="docs-heading-anchor" href="#Coverage-of-more-of-the-Language">Coverage of more of the Language</a><a id="Coverage-of-more-of-the-Language-1"></a><a class="docs-heading-anchor-permalink" href="#Coverage-of-more-of-the-Language" title="Permalink"></a></h3><p>The need for first-class support for mutation has been well understood in the Julia AD community for a number of years now. Its primary benefit is the ability to differentiate through the truly vast quantity of mutating code on which users depend in <code>Base</code> / <code>Core</code>, the standard libraries, and packages in the general registry – empowering users to AD through code which <em>they</em> write in a mutating way is often of secondary importance. Thus you should equate <code>rrule!!</code>&#39;s support for mutation with good support for existing code. Conversely, you should equate <code>Zygote.jl</code>&#39;s / <code>ReverseDiff.jl</code>&#39;s patchy support for mutation with patchy support for existing code.</p><p><code>rrule!!</code>s impose no constraints on the types which can be operated on, as with <code>ChainRules</code>&#39;s <code>rrule</code> and <code>Zygote</code>&#39;s <code>_pullback</code>. Consequently, there is in principle nothing to prevent <code>Mooncake.jl</code> from operating on any type, for example, structured arrays, GPU arrays, and complicated <code>struct</code>s / <code>mutable struct</code>s.</p><h3 id="Correctness-and-Testing"><a class="docs-heading-anchor" href="#Correctness-and-Testing">Correctness and Testing</a><a id="Correctness-and-Testing-1"></a><a class="docs-heading-anchor-permalink" href="#Correctness-and-Testing" title="Permalink"></a></h3><p>Mutation support enables writing <code>rrule!!</code>s at a low-level (<code>Core.InstrincFunction</code>s, <code>built-in function</code>s, <code>ccall</code>s to e.g. <code>BLAS</code> and <code>LAPACK</code> and the bits of Base Julia which are implemented in C). The simplicity of this low-level functionality makes implementing correct <code>rrule!!</code>s for it a simple task. In conjunction with being strict about the types used internally to represent (co)tangents, we have found this leads to <code>rrule!!</code>s composing very well, and AD being correct in practice as a consequence.</p><p>Furthermore, the interfaces for <code>rrule!!</code> and the (co)tangent type system have been designed to make a reliable <code>test_rule</code> function possible to create. All of our testing is implemented via this (or via another function which calls this) which makes adding test-cases trivial, and has meant that we have produced a lot of test cases.</p><p>This contrasts with <code>Zygote.jl</code> / <code>ChainRules.jl</code>, where the permissive (co)tangent type system complicates both composition of <code>rrule</code>s and testing.</p><p>Additionally, our approach to AD naturally handles control flow which differs between multiple calls to the same function. This contrasts with e.g. <code>ReverseDiff.jl</code>&#39;s compiled tape, which can give silent numerical errors if control flow ought to differ between gradient evaluations at different arguments.</p><h3 id="Performance"><a class="docs-heading-anchor" href="#Performance">Performance</a><a id="Performance-1"></a><a class="docs-heading-anchor-permalink" href="#Performance" title="Permalink"></a></h3><p>Hand-written <code>rrule!!</code>s have excellent performance, provided that they have been written well (most of the hand-written rules in <code>Mooncake.jl</code> have excellent performance, but some require optimisation. Doing this just requires investing some time). Consequently, whether or not the overall AD system has good performance is largely a question of how much overhead is associated to the mechanism by which hand-written <code>rrules!!</code>s are algorithmically composed.</p><p>At present (03/2024), we do this in a <em>reasonably</em> performant way (but better than the previous way!) See <a href="#Project-Status">Project Status</a> below for more info.</p><p>Additionally, the strategy of immediately incrementing (co)tangents resolves long-standing performance issues associated with indexing arrays.</p><h3 id="Written-entirely-in-Julia"><a class="docs-heading-anchor" href="#Written-entirely-in-Julia">Written entirely in Julia</a><a id="Written-entirely-in-Julia-1"></a><a class="docs-heading-anchor-permalink" href="#Written-entirely-in-Julia" title="Permalink"></a></h3><p><code>Mooncake.jl</code> is written entirely in Julia. This sits in contrast to <code>Enzyme.jl</code>, which targets LLVM and is primarily written in C++. These two approaches entail different tradeoffs.</p><h2 id="Project-Name"><a class="docs-heading-anchor" href="#Project-Name">Project Name</a><a id="Project-Name-1"></a><a class="docs-heading-anchor-permalink" href="#Project-Name" title="Permalink"></a></h2><p>Before an initial release, this package was called <code>Taped.jl</code>, but that name ceased to be helpful when we stopped using a classic &quot;Wengert list&quot;-style type to implement AD. For about 48 hours is was called <code>Phi.jl</code>, but the community guidelines state that the name of packages in the general registry should generally be at least 5 characters in length.</p><p>We then chose <code>Tapir.jl</code>, and didn&#39;t initially feel that other work <a href="https://github.com/wsmoses/Tapir-LLVM">of the same name</a> presented a serious name clash, as it isn&#39;t AD-specific or a Julia project. As it turns out, there has been significant work attempting to integrate the ideas from this work into the <a href="https://github.com/JuliaLang/julia/pull/39773">Julia compiler</a>, so the clash is something of a problem.</p><p>On 18/09/2024 this package was renamed from <code>Tapir.jl</code> to <code>Mooncake.jl</code>. The last version while the package was called <code>Tapir.jl</code> was 0.2.51. Upon renaming, the version was bumped to 0.3.0. We finally settled on <code>Mooncake.jl</code>. Hopefully this name will stick.</p><h2 id="Project-Status"><a class="docs-heading-anchor" href="#Project-Status">Project Status</a><a id="Project-Status-1"></a><a class="docs-heading-anchor-permalink" href="#Project-Status" title="Permalink"></a></h2><p>The plan is to proceed in three phases:</p><ol><li>design, correctness and testing</li><li>performance optimisation</li><li>maintenance</li></ol><p>You should take this with a pinch of salt, as it seems highly likely that we will have to revisit some design choices when optimising performance – we do not, however, anticipate requiring major re-writes to the design as part of performance optimisation. We aim to reach the maintenance phase of the project before 01/06/2024.</p><details class="admonition is-details"><summary class="admonition-header">Updates</summary><div class="admonition-body"><p><em>Update: (07/02/2025)</em> We&#39;re largely in phase 3 now. We&#39;re largely working on documentation, and resolving existing issues. There are several ways that we <em>could</em> improve the performance of Mooncake.jl on e.g. low-level loops, but our feeling is that the performance is generally good <em>enough</em> to mean that it&#39;s more important to ensure that Mooncake is very stable.</p><p><em>Update: (30/04/2024)</em> Phase 2 continues! We are now finding that <code>Mooncake.jl</code> comfortably outperforms compiled <code>ReverseDiff.jl</code> on type-stable code in all of the situations we have tested. Optimising to get similar performance to <code>Enzyme.jl</code> is an on-going process.</p><p><em>Update: (22/03/2024)</em> Phase 2 is now further along. <code>Mooncake.jl</code> now uses something which could reasonably be described as a source-to-source system to perform AD. At present the performance of this system is not as good as that of Enzyme, but often beats compiled ReverseDiff, and comfortably beats Zygote in any situations involving dynamic control flow. The present focus is on dealing with some remaining performance limitations that should make <code>Mooncake.jl</code>&#39;s performance much closer to that of Enzyme, and consistently beat ReverseDiff on a range of benchmarks. Fortunately, dealing with these performance limitations necessitates simplifying the internals substantially.</p><p><em>Update: (16/01/2024)</em> Phase 2 is now well underway. We now make use of a much faster approach to interpreting / executing Julia code, which yields performance that is comparable with ReverseDiff (when things go well). The current focus is on ironing out performance issues, and simplifying the implementation.</p><p><em>Update: (06/11/2023)</em> We are mostly through the first phase. Correctness testing is proceeding well, and we are ironing out known issues. Notably, our broad experience at present is that as we continue to increase the amount of Julia code on which the package is tested, things fail for known, predictable, straightforwardly-fixable reasons (largely missing rrules for <code>ccall</code>s), rather than unanticipated problems. Please note that, since we have yet to enter phase 2 of the project, we have spent <em>no</em> time whatsoever optimising for performance. We strongly believe that there is nothing in principle preventing us from achieving excellent performance. However, currently, you should expect to experience <em>amazingly</em> poor performance.</p></div></details><h3 id="What-things-should-work-well"><a class="docs-heading-anchor" href="#What-things-should-work-well">What things should work well</a><a id="What-things-should-work-well-1"></a><a class="docs-heading-anchor-permalink" href="#What-things-should-work-well" title="Permalink"></a></h3><p>Noteworthy things which should work and be performant include:</p><ol><li>code containing control flow</li><li>value-dependent control flow</li><li>mutation of arrays and mutable structs</li></ol><p>These are noteworthy in the sense that they are different from ReverseDiff / Zygote. Enzyme is also able to do these things.</p><p>Please be aware that by &quot;performant&quot; we mean similar or better performance than ReverseDiff with a compiled tape, but not as good performance as Enzyme.</p><h3 id="What-won&#39;t-work"><a class="docs-heading-anchor" href="#What-won&#39;t-work">What won&#39;t work</a><a id="What-won&#39;t-work-1"></a><a class="docs-heading-anchor-permalink" href="#What-won&#39;t-work" title="Permalink"></a></h3><p>While <code>Mooncake.jl</code> should now work on a very large subset of the language, there remain things that you should expect not to work. A non-exhaustive list of things to bear in mind includes:</p><ol><li>It is always necessary to produce hand-written rules for <code>ccall</code>s (and, more generally, foreigncall nodes). We have rules for many <code>ccall</code>s, but not all. If you encounter a foreigncall without a hand-written rule, you should get an informative error message which tells you what is going on and how to deal with it.</li><li>Builtins which require rules. The vast majority of them have rules now, but some don&#39;t. You should get a sensible error if you encounter a primitive without a rule.</li><li>Anything involving tasks / threading – we have no thread safety guarantees and, at the time of writing, I&#39;m not entirely sure what error you will find if you attempt to AD through code which uses Julia&#39;s task / thread system. The same applies to distributed computing. These limitations ought to be possible to resolve.</li></ol></article><nav class="docs-footer"><a class="docs-footer-nextpage" href="tutorial/">Tutorial »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Thursday 27 March 2025 09:52">Thursday 27 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
