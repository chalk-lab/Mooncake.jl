<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · Mooncake.jl</title><meta name="title" content="Tutorial · Mooncake.jl"/><meta property="og:title" content="Tutorial · Mooncake.jl"/><meta property="twitter:title" content="Tutorial · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Mooncake.jl</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#DifferentiationInterface.jl-API"><span>DifferentiationInterface.jl API</span></a></li><li><a class="tocitem" href="#Mooncake.jl-API"><span>Mooncake.jl API</span></a></li></ul></li><li><a class="tocitem" href="../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../developer_documentation/running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../developer_documentation/developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../developer_documentation/forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../developer_documentation/misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../developer_documentation/internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl/blob/main/docs/src/tutorial.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h1><p>There are two ways to compute gradients with Mooncake.jl:</p><ul><li>through the standardized <a href="https://github.com/JuliaDiff/DifferentiationInterface.jl">DifferentiationInterface.jl</a> API</li><li>through the native Mooncake.jl API</li></ul><p>We recommend the former to start with, especially if you want to experiment with other automatic differentiation packages.</p><pre><code class="language-julia hljs">import DifferentiationInterface as DI
import Mooncake</code></pre><h2 id="DifferentiationInterface.jl-API"><a class="docs-heading-anchor" href="#DifferentiationInterface.jl-API">DifferentiationInterface.jl API</a><a id="DifferentiationInterface.jl-API-1"></a><a class="docs-heading-anchor-permalink" href="#DifferentiationInterface.jl-API" title="Permalink"></a></h2><p>DifferentiationInterface.jl (or DI for short) provides a common entry point for every automatic differentiation package in Julia. To specify that you want to use Mooncake.jl, just create the right &quot;backend&quot; object (with an optional <a href="../interface/#Mooncake.Config"><code>Mooncake.Config</code></a>):</p><pre><code class="language-julia hljs">backend = DI.AutoMooncake(; config=nothing)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ADTypes.AutoMooncake{Nothing}(nothing)</code></pre><p>This object is actually defined by a third package called <a href="https://github.com/SciML/ADTypes.jl">ADTypes.jl</a>, but re-exported by DI.</p><h3 id="Single-argument"><a class="docs-heading-anchor" href="#Single-argument">Single argument</a><a id="Single-argument-1"></a><a class="docs-heading-anchor-permalink" href="#Single-argument" title="Permalink"></a></h3><p>Suppose you want to differentiate the following function</p><pre><code class="language-julia hljs">f(x) = sum(abs2, x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">f (generic function with 1 method)</code></pre><p>on the following input</p><pre><code class="language-julia hljs">x = float.(1:3)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Float64}:
 1.0
 2.0
 3.0</code></pre><p>The naive way is to simply call <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.gradient"><code>DI.gradient</code></a>:</p><pre><code class="language-julia hljs">DI.gradient(f, backend, x)  # slow, do not do this</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>This returns the correct gradient, but it is very slow because it includes the time taken by Mooncake.jl to compute a differentiation rule for <code>f</code> (see <a href="../understanding_mooncake/rule_system/#Mooncake.jl&#39;s-Rule-System">Mooncake.jl&#39;s Rule System</a>). If you anticipate you will need more than one gradient, it is better to call <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.prepare_gradient"><code>DI.prepare_gradient</code></a> on a typical (e.g. random) input first:</p><pre><code class="language-julia hljs">typical_x = rand(3)
prep = DI.prepare_gradient(f, backend, typical_x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">DifferentiationInterfaceMooncakeExt.MooncakeGradientPrep{Mooncake.Cache{Mooncake.DerivedRule{Tuple{typeof(Main.f), Vector{Float64}}, Tuple{Mooncake.CoDual{typeof(Main.f), Mooncake.NoFData}, Mooncake.CoDual{Vector{Float64}, Vector{Float64}}}, Mooncake.CoDual{Float64, Mooncake.NoFData}, Tuple{Float64}, Tuple{Mooncake.NoRData, Mooncake.NoRData}, false, Val{2}}, Float64, Tuple{Mooncake.NoTangent, Vector{Float64}}}}(Mooncake.Cache{Mooncake.DerivedRule{Tuple{typeof(Main.f), Vector{Float64}}, Tuple{Mooncake.CoDual{typeof(Main.f), Mooncake.NoFData}, Mooncake.CoDual{Vector{Float64}, Vector{Float64}}}, Mooncake.CoDual{Float64, Mooncake.NoFData}, Tuple{Float64}, Tuple{Mooncake.NoRData, Mooncake.NoRData}, false, Val{2}}, Float64, Tuple{Mooncake.NoTangent, Vector{Float64}}}(Mooncake.DerivedRule{Tuple{typeof(Main.f), Vector{Float64}}, Tuple{Mooncake.CoDual{typeof(Main.f), Mooncake.NoFData}, Mooncake.CoDual{Vector{Float64}, Vector{Float64}}}, Mooncake.CoDual{Float64, Mooncake.NoFData}, Tuple{Float64}, Tuple{Mooncake.NoRData, Mooncake.NoRData}, false, Val{2}}(MistyClosure (::Mooncake.CoDual{typeof(Main.f), Mooncake.NoFData}, ::Mooncake.CoDual{Vector{Float64}, Vector{Float64}})::Mooncake.CoDual{Float64, Mooncake.NoFData}-&gt;◌, Base.RefValue{MistyClosures.MistyClosure{Core.OpaqueClosure{Tuple{Float64}, Tuple{Mooncake.NoRData, Mooncake.NoRData}}}}(MistyClosure (::Float64)::Tuple{Mooncake.NoRData, Mooncake.NoRData}-&gt;◌), Val{2}()), 0.6908414996342827, (Mooncake.NoTangent(), [0.4550376084302781, 1.5982219823570742, 0.04464603635047015])))</code></pre><p>The typical input should have the same size and type as the actual inputs we will provide later on. As for the contents of the preparation result, they do not matter. What matters is that it captures everything you need for <code>DI.gradient</code> to be fast:</p><pre><code class="language-julia hljs">DI.gradient(f, prep, backend, x)  # fast</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>For optimal speed, you can provide storage space for the gradient and call <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.gradient%21"><code>DI.gradient!</code></a> instead:</p><pre><code class="language-julia hljs">grad = similar(x)
DI.gradient!(f, grad, prep, backend, x)  # very fast</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>If you also need the value of the function, check out <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.value_and_gradient"><code>DI.value_and_gradient</code></a> or <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.value_and_gradient%21"><code>DI.value_and_gradient!</code></a>:</p><pre><code class="language-julia hljs">DI.value_and_gradient(f, prep, backend, x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(14.0, [2.0, 4.0, 6.0])</code></pre><h3 id="Multiple-arguments"><a class="docs-heading-anchor" href="#Multiple-arguments">Multiple arguments</a><a id="Multiple-arguments-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-arguments" title="Permalink"></a></h3><p>What should you do if your function takes more than one input argument? Well, DI can still handle it, <em>assuming that you only want the derivative with respect to one of them</em> (the first one, by convention). For instance, consider the function</p><pre><code class="language-julia hljs">g(x, a, b) = a * f(x) + b</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">g (generic function with 1 method)</code></pre><p>You can easily compute the gradient with respect to <code>x</code>, while keeping <code>a</code> and <code>b</code> fixed. To do that, just wrap these two arguments inside <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.Constant"><code>DI.Constant</code></a>, like so:</p><pre><code class="language-julia hljs">typical_a, typical_b = 1.0, 1.0
prep = DI.prepare_gradient(g, backend, typical_x, DI.Constant(typical_a), DI.Constant(typical_b))

a, b = 42.0, 3.14
DI.value_and_gradient(g, prep, backend, x, DI.Constant(a), DI.Constant(b))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(591.14, [84.0, 168.0, 252.0])</code></pre><p>Note that this works even when you change the value of <code>a</code> or <code>b</code> (those are not baked into the preparation result).</p><p>If one of your additional arguments behaves like a scratch space in memory (instead of a meaningful constant), you can use <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.Cache"><code>DI.Cache</code></a> instead.</p><p>Now what if you care about the derivatives with respect to every argument? You can always go back to the single-argument case by putting everything inside a tuple:</p><pre><code class="language-julia hljs">g_tup(xab) = xab[2] * f(xab[1]) + xab[3]
prep = DI.prepare_gradient(g_tup, backend, (typical_x, typical_a, typical_b))
DI.value_and_gradient(g_tup, prep, backend, (x, a, b))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(591.14, ([84.0, 168.0, 252.0], 14.0, 1.0))</code></pre><p>You can also use the native API of Mooncake.jl, discussed below.</p><h3 id="Beyond-gradients"><a class="docs-heading-anchor" href="#Beyond-gradients">Beyond gradients</a><a id="Beyond-gradients-1"></a><a class="docs-heading-anchor-permalink" href="#Beyond-gradients" title="Permalink"></a></h3><p>Going through DI allows you to compute other kinds of derivatives, like (reverse-mode) Jacobian matrices. The syntax is very similar:</p><pre><code class="language-julia hljs">h(x) = cos.(x) .* sin.(reverse(x))
prep = DI.prepare_jacobian(h, backend, x)
DI.jacobian(h, prep, backend, x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3×3 Matrix{Float64}:
 -0.118748   0.0       -0.534895
  0.0       -0.653644   0.0
 -0.534895   0.0       -0.118748</code></pre><h2 id="Mooncake.jl-API"><a class="docs-heading-anchor" href="#Mooncake.jl-API">Mooncake.jl API</a><a id="Mooncake.jl-API-1"></a><a class="docs-heading-anchor-permalink" href="#Mooncake.jl-API" title="Permalink"></a></h2><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Work in progress.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Mooncake.jl</a><a class="docs-footer-nextpage" href="../interface/">Interface »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Tuesday 4 March 2025 17:47">Tuesday 4 March 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
