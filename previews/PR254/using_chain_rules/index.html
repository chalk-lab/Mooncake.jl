<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Using ChainRules · Mooncake.jl</title><meta name="title" content="Using ChainRules · Mooncake.jl"/><meta property="og:title" content="Using ChainRules · Mooncake.jl"/><meta property="twitter:title" content="Using ChainRules · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Mooncake.jl</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../understanding_intro/">Introduction</a></li><li><a class="tocitem" href="../algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../mathematical_interpretation/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li class="is-active"><a class="tocitem" href>Using ChainRules</a></li><li><a class="tocitem" href="../debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><a class="tocitem" href="../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Utilities</a></li><li class="is-active"><a href>Using ChainRules</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Using ChainRules</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl/blob/main/docs/src/using_chain_rules.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Using-ChainRules.jl"><a class="docs-heading-anchor" href="#Using-ChainRules.jl">Using ChainRules.jl</a><a id="Using-ChainRules.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Using-ChainRules.jl" title="Permalink"></a></h1><p><a href="https://github.com/JuliaDiff/ChainRules.jl">ChainRules.jl</a> provides a large number of rules for differentiating functions in reverse-mode. These rules are methods of the <code>ChainRulesCore.rrule</code> function. There are some instances where there is it most convenient to implement a <code>Mooncake.rrule!!</code> by wrapping an existing <code>ChainRulesCore.rrule</code>.</p><p>There is enough similarity between these two systems that most of the boilerplate code can be avoided. The docstrings below explain this functionality, and how it should / should not be used.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@from_rrule" href="#Mooncake.@from_rrule"><code>Mooncake.@from_rrule</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@from_rrule ctx sig [has_kwargs=false]</code></pre><p>Convenience functionality to assist in using <code>ChainRulesCore.rrule</code>s to write <code>rrule!!</code>s. This macro is a thin wrapper around <a href="#Mooncake.rrule_wrapper"><code>rrule_wrapper</code></a>.</p><p>For example,</p><pre><code class="language-julia hljs">@from_rrule DefaultCtx Tuple{typeof(sin), Float64}</code></pre><p>would define a <code>Mooncake.rrule!!</code> for <code>sin</code> of <code>Float64</code>s by calling <code>ChainRulesCore.rrule</code>.</p><pre><code class="language-julia hljs">@from_rrule DefaultCtx Tuple{typeof(foo), Float64} true</code></pre><p>would define a method of <code>Mooncake.rrule!!</code> which can handle keyword arguments.</p><p>Limitations: it is your responsibility to ensure that</p><ol><li>calls with signature <code>sig</code> do not mutate their arguments,</li><li>the output of calls with signature <code>sig</code> does not alias any of the inputs.</li></ol><p>As with all hand-written rules, you should definitely make use of <a href="../debugging_and_mwes/#Mooncake.TestUtils.test_rule"><code>TestUtils.test_rule</code></a> to verify correctness on some test cases.</p><p><strong>A Note On Type Constraints</strong></p><p>Many methods of <code>ChainRuleCore.rrule</code> are implemented with very loose type constraints. For example, it would not be surprising to see a method of rrule with the signature</p><pre><code class="language-julia hljs">Tuple{typeof(rrule), typeof(foo), Real, AbstractVector{&lt;:Real}}</code></pre><p>There are a variety of reasons for this way of doing things, and whether it is a good idea to write rules for such generic objects has been debated at length.</p><p>Suffice it to say, you should not write rules for this package which are so generically typed. Rather, you should create rules for the subset of types for which you believe that the <code>ChainRulesCore.rrule</code> will work correctly, and leave this package to derive rules for the rest. For example, in the above case you might be confident that the rule will behave correctly for input types <code>Tuple{typeof(foo), IEEEFloat, Vector{&lt;:IEEEFloat}}</code>. You should therefore only write a rule for these types:</p><pre><code class="language-julia hljs">@from_rrule DefaultCtx Tuple{typeof(foo), IEEEFloat, Vector{&lt;:IEEEFloat}}</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/be4df2fc826f6fbf0868397f612551da18ea4aa6/src/chain_rules_interop.jl#L100-L145">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rrule_wrapper" href="#Mooncake.rrule_wrapper"><code>Mooncake.rrule_wrapper</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rrule_wrapper(f::CoDual, args::CoDual...)</code></pre><p>Used to implement <code>rrule!!</code>s via <code>ChainRulesCore.rrule</code>.</p><p>Given a function <code>foo</code>, argument types <code>arg_types</code>, and a method <code>ChainRulesCore.rrule</code> of which applies to these, you can make use of this function as follows:</p><pre><code class="language-julia hljs">Mooncake.@is_primitive DefaultCtx Tuple{typeof(foo), arg_types...}
function Mooncake.rrule!!(f::CoDual{typeof(foo)}, args::CoDual...)
    return rrule_wrapper(f, args...)
end</code></pre><p>Assumes that methods of <code>to_cr_tangent</code> and <code>to_mooncake_tangent</code> are defined such that you can convert between the different representations of tangents that Mooncake and ChainRulesCore expect.</p><p>Furthermore, it is <em>essential</em> that</p><ol><li><code>f(args)</code> does not mutate <code>f</code> or <code>args</code>, and</li><li>the result of <code>f(args)</code> does not alias any data stored in <code>f</code> or <code>args</code>.</li></ol><p>Subject to some constraints, you can use the <a href="#Mooncake.@from_rrule"><code>@from_rrule</code></a> macro to reduce the amount of boilerplate code that you are required to write even further.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/be4df2fc826f6fbf0868397f612551da18ea4aa6/src/chain_rules_interop.jl#L26-L49">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../mathematical_interpretation/">« Mooncake.jl&#39;s Rule System</a><a class="docs-footer-nextpage" href="../debug_mode/">Debug Mode »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 1 October 2024 12:48">Tuesday 1 October 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
