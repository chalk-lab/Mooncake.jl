<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Misc. Internals Notes · Mooncake.jl</title><meta name="title" content="Misc. Internals Notes · Mooncake.jl"/><meta property="og:title" content="Misc. Internals Notes · Mooncake.jl"/><meta property="twitter:title" content="Misc. Internals Notes · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../forwards_mode_design/">Forwards-Mode Design</a></li><li class="is-active"><a class="tocitem" href>Misc. Internals Notes</a><ul class="internal"><li><a class="tocitem" href="#tangent_type-and-friends"><span><code>tangent_type</code> and friends</span></a></li></ul></li><li><a class="tocitem" href="../internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li class="is-active"><a href>Misc. Internals Notes</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Misc. Internals Notes</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl/blob/main/docs/src/developer_documentation/misc_internals_notes.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Misc.-Internals-Notes"><a class="docs-heading-anchor" href="#Misc.-Internals-Notes">Misc. Internals Notes</a><a id="Misc.-Internals-Notes-1"></a><a class="docs-heading-anchor-permalink" href="#Misc.-Internals-Notes" title="Permalink"></a></h1><p>This document contains an assortment of notes on some implementation details in Mooncake.jl. It is occassionally helpful to have them here for reference, but they are typically not essential reading unless working on the specific parts of Mooncake.jl to which they pertain.</p><h2 id="tangent_type-and-friends"><a class="docs-heading-anchor" href="#tangent_type-and-friends"><code>tangent_type</code> and friends</a><a id="tangent_type-and-friends-1"></a><a class="docs-heading-anchor-permalink" href="#tangent_type-and-friends" title="Permalink"></a></h2><p>Date: 21/01/2025 This note was written for v1.10.7 and v1.11.2.</p><h3 id="Background"><a class="docs-heading-anchor" href="#Background">Background</a><a id="Background-1"></a><a class="docs-heading-anchor-permalink" href="#Background" title="Permalink"></a></h3><p>Mooncake.jl makes extensive use of <code>@generated</code> functions to ensure that its <code>tangent_type</code> function (among others) is both type-stable, and constant folds. I recently changed how <code>tangent_type</code> is implemented in Mooncake.jl to ensure that the implementations respect some specific limitations of generated functions. Here I outline the overall problem, the mistake the previous implementation made, and how <a href="https://github.com/compintell/Mooncake.jl/pull/426">the recent changes</a> fix it.</p><h3 id="tangent_type"><a class="docs-heading-anchor" href="#tangent_type"><code>tangent_type</code></a><a id="tangent_type-1"></a><a class="docs-heading-anchor-permalink" href="#tangent_type" title="Permalink"></a></h3><p><code>tangent_type</code> is a regular Julia function, which given a &quot;primal&quot; type returns another type, the tangent type. It is side-effect free, and its return value is determined entirely by the <em>type</em> of its argument. This means it should be possible to constant-fold. For example, consider the following definitions:</p><pre><code class="language-julia hljs">tangent_type(::Type{Float64}) = Float64
tangent_type(::Type{P}) where {P&lt;:Tuple} = Tuple{map(tangent_type, fieldtypes(P))...}</code></pre><p>If we run this for <code>Float64</code>, we see that everything is as expected – the function literally just returns <code>Float64</code>:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode(tangent_type, (Type{Float64}, ))[1]
 1 ─     return Main.Float64
  =&gt; Type{Float64}</code></pre><p>A simple <code>Tuple</code> type will also have this property:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode(tangent_type, (Type{Tuple{Float64}}, ))[1]
 1 ─     return Tuple{Float64}
  =&gt; Type{Tuple{Float64}}</code></pre><p>However, for even slightly more complicated types, things fall over:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode(tangent_type, (Type{Tuple{Tuple{Float64}}}, ))[1]
1 1 ─ %1 = Main.tangent_type::Core.Const(tangent_type)
  │   %2 = invoke %1(Tuple{Float64}::Type{Tuple{Float64}})::Type{&lt;:Tuple}
  │   %3 = Core.apply_type(Tuple, %2)::Type{&lt;:Tuple}
  └──      return %3
   =&gt; Type{&lt;:Tuple}</code></pre><p>This was one particular example, but it is really very straightforward to find others, necessitating a hunt for a more robust way of implementing tangent_type.</p><h3 id="Bad-Generated-Function-Implementation"><a class="docs-heading-anchor" href="#Bad-Generated-Function-Implementation">Bad Generated Function Implementation</a><a id="Bad-Generated-Function-Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Bad-Generated-Function-Implementation" title="Permalink"></a></h3><p>You might think to instead implement <code>tangent_type</code> for <code>Tuple</code>s as follows:</p><pre><code class="language-julia hljs">bad_tangent_type(::Type{Float64}) = Float64
@generated function bad_tangent_type(::Type{P}) where {P&lt;:Tuple}
    return Tuple{map(bad_tangent_type, fieldtypes(P))...}
end
bad_tangent_type(::Type{Float32}) = Float32</code></pre><p>Since the generated function literally just returns the type that we want, it will definitely constant-fold:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode(bad_tangent_type, (Type{Tuple{Tuple{Float64}}}, ))[1]
1 1 ─     return Tuple{Tuple{Float64}}
   =&gt; Type{Tuple{Tuple{Float64}}}</code></pre><p>However, this implementation has a crucial flaw: we rely on the definition of <code>bad_tangent_type</code> in the body of the <code>@generated</code> method of <code>bad_tangent_type</code>. This means that if we e.g. add methods to <code>bad_tangent_type</code> after the initial definition, they won&#39;t show up. For example, in the above block, we defined the method of <code>bad_tangent_type</code> for <code>Float32</code> <em>after</em> that of <code>Tuple</code>s. This results in the following error when we call <code>bad_tangent_type(Tuple{Float32})</code>:</p><pre><code class="language-julia hljs">julia&gt; bad_tangent_type(Tuple{Float32})
ERROR: MethodError: no method matching bad_tangent_type(::Type{Float32})
The applicable method may be too new: running in world age 26713, while current world is 26714.

Closest candidates are:
  bad_tangent_type(::Type{Float32}) (method too new to be called from this world context.)
   @ Main REPL[10]:1
  bad_tangent_type(::Type{Float64})
   @ Main REPL[8]:1
  bad_tangent_type(::Type{P}) where P&lt;:Tuple
   @ Main REPL[9]:1

Stacktrace:
 [1] map(f::typeof(bad_tangent_type), t::Tuple{DataType})
   @ Base ./tuple.jl:355
 [2] #s1#1
   @ ./REPL[9]:2 [inlined]
 [3] var&quot;#s1#1&quot;(P::Any, ::Any, ::Any)
   @ Main ./none:0
 [4] (::Core.GeneratedFunctionStub)(::UInt64, ::LineNumberNode, ::Any, ::Vararg{Any})
   @ Core ./boot.jl:707
 [5] top-level scope
   @ REPL[12]:1</code></pre><p>This behaviour of <code>@generated</code> functions is discussed in the <a href="https://docs.julialang.org/en/v1/manual/metaprogramming/#Generated-functions">Julia docs</a> – I would recommend reading this bit of the docs if you&#39;ve not previously, as the explanation is quite clear.</p><h3 id="Good-Generated-Function-Implementation"><a class="docs-heading-anchor" href="#Good-Generated-Function-Implementation">Good Generated Function Implementation</a><a id="Good-Generated-Function-Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Good-Generated-Function-Implementation" title="Permalink"></a></h3><p><code>@generated</code> functions can still come to our rescue though. A better implementation is as follows:</p><pre><code class="language-julia hljs">good_tangent_type(::Type{Float64}) = Float64
@generated function good_tangent_type(::Type{P}) where {P&lt;:Tuple}
    exprs = map(p -&gt; :(good_tangent_type($p)), fieldtypes(P))
    return Expr(:curly, :Tuple, exprs...)
end
good_tangent_type(::Type{Float32}) = Float32</code></pre><p>This leads to generated code which constant-folds / infers correctly:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode(good_tangent_type, (Type{Tuple{Tuple{Float64}}}, ))[1]
1 1 ─     return Tuple{Tuple{Float64}}
   =&gt; Type{Tuple{Tuple{Float64}}}</code></pre><p>I believe this works better because the recursion doesn&#39;t happen through another function, but appears directly in the function body. This is right at the edge of my understanding of Julia&#39;s compiler heuristics surrounding recursion though, so I might be mistaken.</p><p>It also behaves correctly under the addition of new methods of <code>good_tangent_type</code>, because <code>good_tangent_type</code> only appears in the expression returned by the generated function, not the body of the generated function itself:</p><pre><code class="language-julia hljs">julia&gt; good_tangent_type(Tuple{Float32})
Tuple{Float32}</code></pre><h3 id="Effects-Etc"><a class="docs-heading-anchor" href="#Effects-Etc">Effects Etc</a><a id="Effects-Etc-1"></a><a class="docs-heading-anchor-permalink" href="#Effects-Etc" title="Permalink"></a></h3><p>This implementation is nearly sufficient to guarantee correct performance in all situations. However, in some cases it is possible that even this implementation will fall over. Annoyingly I&#39;ve not managed to produce a MWE that is even vaguely minimal in order to support this example, so you&#39;ll just have to believe me.</p><p>Based on all of the examples that I have seen thus far, it appears to be true that if you just <em>tell</em> the compiler that</p><ol><li>for the same inputs, the function always returns the same outputs, and</li><li>the function has no side-effects, so can be removed,</li></ol><p>everything will always constant fold nicely. This can be achieved by using the <code>Base.@assume_effects</code> macro in your method definitions, with the effects <code>:consistent</code> and <code>:removable</code>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../forwards_mode_design/">« Forwards-Mode Design</a><a class="docs-footer-nextpage" href="../internal_docstrings/">Internal Docstrings »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 22 January 2025 09:27">Wednesday 22 January 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
