<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Towards AD in Julia: Composition of Rules (to-be-updated) · Mooncake.jl</title><meta name="title" content="Towards AD in Julia: Composition of Rules (to-be-updated) · Mooncake.jl"/><meta property="og:title" content="Towards AD in Julia: Composition of Rules (to-be-updated) · Mooncake.jl"/><meta property="twitter:title" content="Towards AD in Julia: Composition of Rules (to-be-updated) · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body>
<!-- NAVBAR START -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap');

    /* Documenter.jl CSS Overrides */
    html {
        scroll-padding-top: calc(var(--navbar-height) + 1rem);
    }
    .docs-sidebar, #documenter {
        margin-top: var(--navbar-height);
    }
    .docs-version-selector {
        margin-bottom: 60px !important;
    }
    @media screen and (max-width: 1056px) {
        .docs-version-selector {
            margin-bottom: 60px !important;
        }
        .docs-sidebar {
            margin-top: 0 !important;
        }
    }
    /* End of Documenter.jl Tweaks */

    /* Color and Font Variables */
    :root {
        --heading-color: #6c757d;
        --item-color: rgb(165, 165, 165);
        --primary-bg: white;
        --hover-color: #8faad2;
        --deprecated-bg: #ff4d4d;
        --deprecated-text: white;
        --icon-color: #6c757d;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --dropdown-hover-bg: #e9ecef;
        
        /* Typography */
        --font-family: "Source Sans Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        --nav-link-font-size: 1.0625rem;
        --turing-title-font-size: 21.25px;
        --icon-font-size: 1.25rem;
        --dropdown-arrow-font-size: 0.6875rem;
        --badge-font-size: 0.75rem;

        /* Sizing and Spacing */
        --navbar-height: 3.75rem;
        --logo-height: 31px;
        --logo-width: auto;
        --logo-padding-top: 7px;
        --logo-margin-left: 0.8rem;
        --title-margin-left: 0.4px;
        --title-nav-spacing: 1.1rem;
        --nav-item-margin-left: 1.3rem;
        --icon-margin-left: 1rem;
        --dropdown-padding: 1.875rem;
        --dropdown-item-width: 12.5rem;
        --dropdown-subitem-width: 15.625rem;
        --dropdown-subitem-padding: 0.125rem 0.625rem;
    }

    /* Dark Theme Variable Overrides */
    html.theme--documenter-dark {
        --heading-color: #e0e0e0;
        --item-color: #bdbdbd;
        --primary-bg: #1f2424;
        --hover-color: #ffffff;
        --icon-color: #e0e0e0;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #424242;
    }

    /* Catppuccin Theme Overrides */
    html.theme--catppuccin-latte {
        --heading-color: #4c4f69;
        --primary-bg: #eff1f5;
        --icon-color: #4c4f69;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --dropdown-hover-bg: #e6e9ef;
    }
    html.theme--catppuccin-frappe {
        --heading-color: #c6d0f5;
        --primary-bg: #303446;
        --icon-color: #c6d0f5;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #51576d;
    }
    html.theme--catppuccin-macchiato {
        --heading-color: #cad3f5;
        --primary-bg: #24273a;
        --icon-color: #cad3f5;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #494d64;
    }
    html.theme--catppuccin-mocha {
        --heading-color: #cad3f5;
        --primary-bg: #1e1e2e;
        --icon-color: #cad3f5;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #45475a;
    }


    /* Main Navigation Bar */
    .ext-navigation {
        font-family: var(--font-family);
        position: fixed;
        height: var(--navbar-height);
        top: 0;
        width: 100%;
        background-color: var(--primary-bg);
        z-index: 1000;
        box-shadow: 0 2px 4px var(--shadow-color);
        display: flex;
        align-items: center;
        padding: 0 1.0625rem;
        transition: transform 0.3s, background-color 0.3s;
    }

    nav.ext-navigation .ext-navbar-logo {
        margin-left: var(--logo-margin-left);
        height: auto;
        max-height: var(--logo-height);
        width: auto;
        padding-top: var(--logo-padding-top);
    }
    
    /* Theme-aware logo text color */
    .ext-navbar-logo .logo-text {
        fill: var(--heading-color);
    }
    
    .ext-navbar-title {
        color: var(--heading-color) !important;
        font-size: var(--turing-title-font-size) !important;
        margin-left: var(--title-margin-left);
        text-decoration: none;
        transition: color 0.2s ease;
    }
    
    .ext-navbar-title:hover {
        color: var(--hover-color) !important;
    }

    .ext-nav-links {
        display: flex;
        align-items: center;
        list-style-type: none;
        margin: 0;
        padding: 0;
        flex-grow: 1;
        margin-left: var(--title-nav-spacing);
    }

    .ext-nav-links li:first-child {
        margin-left: 0 !important;
    }

    .ext-nav-links li {
        margin-left: var(--nav-item-margin-left) !important;
    }

    .ext-nav-link {
        color: var(--heading-color) !important;
        text-decoration: none;
        font-size: var(--nav-link-font-size) !important;
        transition: color 0.2s ease;
        cursor: pointer;
    }

    .ext-nav-link:hover,
    .ext-navbar-item-single a:hover,
    .ext-navbar-icons a:hover {
        color: var(--hover-color) !important;
    }

    .ext-navbar-item-single a {
        color: var(--heading-color) !important;
    }
    
    .ext-navbar-icons {
        display: flex;
        align-items: center;
    }

    .ext-navbar-icons a {
        color: var(--icon-color) !important;
        font-size: var(--icon-font-size) !important;
        transition: color 0.2s ease;
        margin-left: var(--icon-margin-left);
    }

    .ext-menu-toggle {
        display: none;
        font-size: 1.5rem;
        color: var(--heading-color);
        cursor: pointer;
    }

    .ext-dropdown {
        display: none;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        padding: var(--dropdown-padding);
        position: absolute;
        top: var(--navbar-height);
        width: 100%;
        left: 0;
        background-color: var(--primary-bg);
        line-height: 1.875rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, background-color 0.3s;
        transform: translateY(-0.625rem);
        box-shadow: 0 4px 6px var(--shadow-color);
    }

    #library-handler::after {
        content: "▼";
        font-size: var(--dropdown-arrow-font-size);
        margin-left: 0.3125rem;
        transition: transform 0.3s ease-in-out;
    }

    #library-handler.open::after {
        content: "▲";
    }

    .ext-dropdown.show {
        display: grid;
        opacity: 1;
        transform: translateY(0);
    }

    .ext-dropdown ul {
        width: var(--dropdown-item-width);
        margin-bottom: 1.25rem;
    }

    .ext-dropdown ul li {
        text-align: left;
        display: flex;
        align-items: center;
    }

    .ext-dropdown ul a li {
        color: var(--item-color);
        width: var(--dropdown-subitem-width);
        border-radius: 3px;
        padding: var(--dropdown-subitem-padding);
        transition: background-color 0.2s ease;
    }

    .ext-dropdown ul a li:hover {
        background-color: var(--dropdown-hover-bg);
    }

    .ext-dropdown-item-heading {
        color: var(--heading-color);
        text-align: center;
    }

    .deprecated-badge {
        background-color: var(--deprecated-bg);
        color: var(--deprecated-text);
        font-size: var(--badge-font-size);
        padding: .1rem;
        border-radius: 3px;
        margin-left: 0.5rem;
        line-height: 1;
    }

    @media (max-width: 966px) {
        .ext-dropdown {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .ext-nav-links {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background-color: var(--primary-bg);
            position: absolute;
            top: var(--navbar-height);
            left: 0;
            padding: 0.625rem 0;
            height: auto;
            overflow-y: auto;
            box-shadow: 0 4px 6px var(--shadow-color);
            margin-left: 0;
        }

        .ext-nav-links.show {
            display: flex;
        }

        .ext-nav-links li {
            margin: 0.625rem 0 !important;
            text-align: center;
        }
        
        .ext-menu-toggle {
            display: block;
            margin-left: auto;
        }

        .ext-navigation.hide {
            transform: translateY(calc(-1 * var(--navbar-height)));
        }

        .ext-dropdown {
            position: static;
            display: block;
            opacity: 1;
            transform: none;
            box-shadow: none;
            grid-template-columns: 1fr;
            padding: 0.625rem;
            text-align: center;
        }

        .ext-dropdown ul {
            width: auto;
            display: inline-block;
            margin: 0 auto 0.3125rem;
            text-align: left;
        }
    }
</style>
<nav class="ext-navigation">
    <a href="https://turinglang.org/">
        <svg width="4333" height="1145" viewBox="0 0 4333 1145" fill="none" xmlns="http://www.w3.org/2000/svg" class="ext-navbar-logo">
            <path class="logo-text" d="M0.44603 193.181V66.9868H663.471V193.181H406.62V898H257.297V193.181H0.44603ZM1097.24 635.874V274.74H1244.13V898H1101.7V787.225H1095.21C1081.14 822.121 1058.01 850.66 1025.82 872.842C993.902 895.024 954.542 906.115 907.744 906.115C866.896 906.115 830.783 897.053 799.403 878.929C768.295 860.534 743.948 833.889 726.365 798.993C708.782 763.826 699.99 721.356 699.99 671.581V274.74H846.878V648.858C846.878 688.353 857.699 719.733 879.34 742.997C900.981 766.261 929.385 777.893 964.551 777.893C986.192 777.893 1007.16 772.618 1027.45 762.068C1047.73 751.518 1064.37 735.828 1077.35 714.999C1090.61 693.899 1097.24 667.524 1097.24 635.874ZM1395.17 898V274.74H1537.6V378.617H1544.09C1555.45 342.639 1574.93 314.911 1602.52 295.434C1630.38 275.687 1662.17 265.813 1697.88 265.813C1705.99 265.813 1715.05 266.219 1725.06 267.031C1735.34 267.572 1743.86 268.518 1750.63 269.871V404.992C1744.4 402.828 1734.53 400.934 1721 399.311C1707.75 397.417 1694.9 396.471 1682.46 396.471C1655.68 396.471 1631.6 402.287 1610.23 413.919C1589.13 425.28 1572.49 441.105 1560.32 461.393C1548.15 481.682 1542.06 505.081 1542.06 531.591V898H1395.17ZM1848.21 898V274.74H1995.1V898H1848.21ZM1922.06 186.283C1898.8 186.283 1878.78 178.573 1862.01 163.154C1845.24 147.464 1836.85 128.664 1836.85 106.752C1836.85 84.5701 1845.24 65.7695 1862.01 50.3503C1878.78 34.6606 1898.8 26.8158 1922.06 26.8158C1945.6 26.8158 1965.61 34.6606 1982.12 50.3503C1998.89 65.7695 2007.27 84.5701 2007.27 106.752C2007.27 128.664 1998.89 147.464 1982.12 163.154C1965.61 178.573 1945.6 186.283 1922.06 186.283ZM2293.04 532.809V898H2146.15V274.74H2286.54V380.646H2293.85C2308.18 345.75 2331.04 318.022 2362.42 297.463C2394.07 276.904 2433.16 266.625 2479.69 266.625C2522.7 266.625 2560.17 275.822 2592.09 294.217C2624.28 312.612 2649.17 339.257 2666.75 374.153C2684.6 409.049 2693.39 451.385 2693.12 501.159V898H2546.24V523.882C2546.24 482.223 2535.41 449.626 2513.77 426.092C2492.4 402.557 2462.78 390.79 2424.91 390.79C2399.21 390.79 2376.35 396.471 2356.34 407.832C2336.59 418.923 2321.03 435.019 2309.67 456.119C2298.58 477.218 2293.04 502.782 2293.04 532.809ZM3113.5 1144.71C3060.75 1144.71 3015.44 1137.54 2977.57 1123.2C2939.7 1109.13 2909.26 1090.2 2886.27 1066.39C2863.28 1042.59 2847.32 1016.21 2838.39 987.269L2970.67 955.213C2976.62 967.386 2985.28 979.424 2996.64 991.327C3008 1003.5 3023.28 1013.51 3042.49 1021.35C3061.97 1029.47 3086.45 1033.53 3115.93 1033.53C3157.59 1033.53 3192.08 1023.38 3219.4 1003.09C3246.73 983.076 3260.39 950.074 3260.39 904.087V786.008H3253.08C3245.51 801.157 3234.42 816.711 3219.81 832.671C3205.47 848.632 3186.4 862.022 3162.6 872.842C3139.06 883.663 3109.44 889.073 3073.73 889.073C3025.85 889.073 2982.44 877.847 2943.48 855.394C2904.8 832.671 2873.96 798.857 2850.97 753.952C2828.24 708.777 2816.88 652.24 2816.88 584.341C2816.88 515.902 2828.24 458.147 2850.97 411.078C2873.96 363.739 2904.93 327.896 2943.89 303.55C2982.84 278.933 3026.26 266.625 3074.14 266.625C3110.66 266.625 3140.69 272.847 3164.22 285.29C3188.03 297.463 3206.96 312.206 3221.03 329.519C3235.09 346.561 3245.78 362.657 3253.08 377.805H3261.2V274.74H3406.06V908.144C3406.06 961.435 3393.34 1005.53 3367.92 1040.42C3342.49 1075.32 3307.73 1101.43 3263.63 1118.74C3219.54 1136.05 3169.5 1144.71 3113.5 1144.71ZM3114.72 773.835C3145.83 773.835 3172.34 766.261 3194.25 751.112C3216.16 735.963 3232.79 714.187 3244.16 685.783C3255.52 657.379 3261.2 623.295 3261.2 583.53C3261.2 544.305 3255.52 509.95 3244.16 480.465C3233.07 450.979 3216.56 428.12 3194.65 411.89C3173.01 395.389 3146.37 387.138 3114.72 387.138C3081.98 387.138 3054.66 395.659 3032.75 412.701C3010.84 429.744 2994.34 453.143 2983.25 482.899C2972.16 512.385 2966.61 545.929 2966.61 583.53C2966.61 621.672 2972.16 655.08 2983.25 683.754C2994.61 712.158 3011.25 734.34 3033.16 750.3C3055.34 765.99 3082.53 773.835 3114.72 773.835ZM3647.08 906.927C3622.47 906.927 3601.37 898.271 3583.78 880.958C3566.2 863.645 3557.54 842.545 3557.82 817.658C3557.54 793.312 3566.2 772.482 3583.78 755.17C3601.37 737.857 3622.47 729.2 3647.08 729.2C3670.89 729.2 3691.58 737.857 3709.17 755.17C3727.02 772.482 3736.08 793.312 3736.35 817.658C3736.08 834.159 3731.75 849.173 3723.37 862.698C3715.25 876.224 3704.43 887.044 3690.91 895.16C3677.65 903.004 3663.04 906.927 3647.08 906.927ZM3888.01 274.74H4034.9V933.708C4034.9 978.613 4026.38 1015.67 4009.33 1044.89C3992.29 1074.1 3967.67 1095.88 3935.48 1110.22C3903.29 1124.55 3864.2 1131.72 3818.22 1131.72C3812.81 1131.72 3807.8 1131.59 3803.2 1131.32C3798.6 1131.32 3793.6 1131.18 3788.19 1130.91V1011.21C3792.25 1011.48 3795.9 1011.62 3799.15 1011.62C3802.39 1011.89 3805.77 1012.02 3809.29 1012.02C3837.42 1012.02 3857.58 1005.12 3869.75 991.327C3881.92 977.801 3888.01 957.918 3888.01 931.679V274.74ZM3961.05 186.283C3937.51 186.283 3917.36 178.573 3900.59 163.154C3884.09 147.464 3875.84 128.664 3875.84 106.752C3875.84 84.5701 3884.09 65.7695 3900.59 50.3503C3917.36 34.6606 3937.51 26.8158 3961.05 26.8158C3984.31 26.8158 4004.19 34.6606 4020.7 50.3503C4037.47 65.7695 4045.85 84.5701 4045.85 106.752C4045.85 128.664 4037.47 147.464 4020.7 163.154C4004.19 178.573 3984.31 186.283 3961.05 186.283ZM4332.83 66.9868V898H4185.94V66.9868H4332.83Z" fill="currentColor"/>
            <path d="M4076 108.5C4076 168.424 4027.42 217 3967.5 217C3907.58 217 3859 168.424 3859 108.5C3859 48.5762 3907.58 0 3967.5 0C4027.42 0 4076 48.5762 4076 108.5Z" fill="#389725"/>
            <path d="M3755 814.5C3755 874.424 3706.42 923 3646.5 923C3586.58 923 3538 874.424 3538 814.5C3538 754.576 3586.58 706 3646.5 706C3706.42 706 3755 754.576 3755 814.5Z" fill="#9457B1"/>
            <path d="M2030 108.5C2030 168.424 1981.42 217 1921.5 217C1861.58 217 1813 168.424 1813 108.5C1813 48.5762 1861.58 0 1921.5 0C1981.42 0 2030 48.5762 2030 108.5Z" fill="#CA3B33"/>
        </svg>
    </a>
    <!-- <a class="ext-navbar-title" href="https://turinglang.org/">Turing.jl</a> -->
    
    <ul class="ext-nav-links">
        <li><a class="ext-nav-link" href="https://turinglang.org/docs/getting-started/">Get Started</a></li>
        <li><a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/">Tutorials</a></li>
        <li><a class="ext-nav-link" href="https://turinglang.org/docs/faq/">FAQ</a></li>
        <li>
            <p class="ext-nav-link" id="library-handler">Libraries</p>
            <div class="ext-dropdown" id="ext-dropdown-items">
                <ul>
                    <li class="ext-dropdown-item-heading">Modelling Languages</li>
                    <a href="https://turinglang.org/DynamicPPL.jl/"><li>DynamicPPL</li></a>
                    <a href="https://turinglang.org/JuliaBUGS.jl/"><li>JuliaBUGS</li></a>
                    <a href="https://turinglang.org/TuringGLM.jl/"><li>TuringGLM</li></a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">MCMC</li>
                    <a href="https://turinglang.org/AdvancedHMC.jl/"><li>AdvancedHMC</li></a>
                    <a href="https://turinglang.org/AbstractMCMC.jl/"><li>AbstractMCMC</li></a>
                    <a href="https://github.com/theogf/ThermodynamicIntegration.jl"><li>ThermodynamicIntegration</li></a>
                    <a href="https://turinglang.org/AdvancedPS.jl/"><li>AdvancedPS</li></a>
                    <a href="https://turinglang.org/SliceSampling.jl/"><li>SliceSampling</li></a>
                    <a href="https://turinglang.org/EllipticalSliceSampling.jl/"><li>EllipticalSliceSampling</li></a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Diagnostics</li>
                    <a href="https://turinglang.org/MCMCChains.jl/"><li>MCMCChains</li></a>
                    <a href="https://turinglang.org/MCMCDiagnosticTools.jl/"><li>MCMCDiagnosticTools</li></a>
                    <a href="https://turinglang.org/ParetoSmooth.jl/"><li>ParetoSmooth</li></a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Gaussian Processes</li>
                    <a href="https://juliagaussianprocesses.github.io/AbstractGPs.jl/"><li>AbstractGPs</li></a>
                    <a href="https://juliagaussianprocesses.github.io/KernelFunctions.jl/"><li>KernelFunctions</li></a>
                    <a href="https://juliagaussianprocesses.github.io/ApproximateGPs.jl/"><li>ApproximateGPs</li></a>
                </ul>
                <ul><li class="ext-dropdown-item-heading ext-navbar-item-single"><a href="https://turinglang.org/Bijectors.jl/">Bijectors</a></li></ul>
                <ul><li class="ext-dropdown-item-heading ext-navbar-item-single"><a href="https://turinglang.org/TuringCallbacks.jl/">TuringCallbacks</a></li></ul>
                <ul><li class="ext-dropdown-item-heading ext-navbar-item-single"><a href="https://turinglang.org/Deprecated/TuringBenchmarking/">TuringBenchmarking</a><span class="deprecated-badge">Deprecated</span></li></ul>
            </div>
        </li>
        <li><a class="ext-nav-link" href="https://turinglang.org/news/">News</a></li>
        <li><a class="ext-nav-link" href="https://turinglang.org/team/">Team</a></li>
    </ul>

    <div class="ext-navbar-icons">
        <a href="https://x.com/TuringLang" aria-label="Turing on X"><i class="fa-brands fa-x-twitter"></i></a>
        <a href="https://discourse.julialang.org/c/domain/probprog/48" aria-label="Turing on Discourse"><i class="fa-brands fa-discourse"></i></a>
        <a href="https://julialang.slack.com/archives/CCYDC34A0" aria-label="Turing on Slack"><i class="fa-brands fa-slack"></i></a>
        <a href="https://github.com/TuringLang/" aria-label="Turing.jl on GitHub"><i class="fa-brands fa-github"></i></a>
    </div>

    <span class="ext-menu-toggle"><i class="fa-solid fa-bars"></i></span>
</nav>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const menuToggle = document.querySelector(".ext-menu-toggle");
        const navLinks = document.querySelector(".ext-nav-links");
        const nav = document.querySelector(".ext-navigation");
        const libraryHandler = document.getElementById("library-handler");
        const dropdownContainer = document.getElementById("ext-dropdown-items");
        let lastScrollY = window.scrollY;

        function closeDropdown() {
            if (dropdownContainer.classList.contains("show")) {
                libraryHandler.classList.remove("open");
                dropdownContainer.classList.remove("show");
                setTimeout(() => {
                    if (!dropdownContainer.classList.contains("show")) {
                        dropdownContainer.style.display = "none";
                    }
                }, 300);
            }
        }

        function openDropdown() {
            dropdownContainer.style.display = "grid";
            libraryHandler.classList.add("open");
            setTimeout(() => {
                dropdownContainer.classList.add("show");
            }, 10);
        }

        function setAppropriateHeight() {
            if (window.innerWidth <= 768) {
                const viewportHeight = window.innerHeight;
                const navHeight = nav.offsetHeight;
                navLinks.style.maxHeight = `${viewportHeight - navHeight}px`;
                navLinks.style.overflowY = "auto";
            } else {
                navLinks.style.maxHeight = "";
                navLinks.style.overflowY = "";
            }
        }

        menuToggle.addEventListener("click", (event) => {
            event.stopPropagation();
            navLinks.classList.toggle("show");
            if (navLinks.classList.contains("show")) {
                setAppropriateHeight();
                closeDropdown();
                dropdownContainer.style.display = "none";
            }
        });

        libraryHandler.addEventListener("click", (event) => {
            event.stopPropagation();
            event.preventDefault();
            if (dropdownContainer.classList.contains("show")) {
                closeDropdown();
            } else {
                openDropdown();
            }
            setAppropriateHeight();
        });

        // Close all menus if a click is registered outside the navigation bar.
        document.addEventListener("click", (event) => {
            if (!nav.contains(event.target)) {
                navLinks.classList.remove("show");
                closeDropdown();
            }
        });

        // Hide navigation bar on scroll down in mobile view.
        window.addEventListener("scroll", () => {
            if (window.innerWidth <= 768) {
                if (window.scrollY > lastScrollY && window.scrollY > nav.offsetHeight){
                    nav.classList.add("hide");
                } else {
                    nav.classList.remove("hide");
                }
                lastScrollY = window.scrollY;
            }
        });

        window.addEventListener("resize", setAppropriateHeight);
    });
</script>
<!-- NAVBAR END -->


<div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Mooncake.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../introduction/">Introduction</a></li><li><a class="tocitem" href="../algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../rule_system/">Mooncake.jl&#39;s Rule System</a></li><li class="is-active"><a class="tocitem" href>Towards AD in Julia: Composition of Rules (to-be-updated)</a><ul class="internal"><li><a class="tocitem" href="#A-Motivating-Example"><span>A Motivating Example</span></a></li><li><a class="tocitem" href="#Part-1:-Simple-Compositions-of-Pure-Functions"><span>Part 1: Simple Compositions of Pure Functions</span></a></li><li><a class="tocitem" href="#Part-2:-Functions-of-Pure-Functions"><span>Part 2: Functions of Pure Functions</span></a></li><li><a class="tocitem" href="#Part-3:-Applying-Sequences-of-Mutating-Functions"><span>Part 3: Applying Sequences of Mutating Functions</span></a></li><li><a class="tocitem" href="#Part-4:-Computational-Graphs-of-Mutating-Functions"><span>Part 4: Computational Graphs of Mutating Functions</span></a></li><li><a class="tocitem" href="#Part-5:-Computational-Graphs-of-Mutating-Functions-with-Aliasing"><span>Part 5: Computational Graphs of Mutating Functions with Aliasing</span></a></li></ul></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../../developer_documentation/running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../../developer_documentation/developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../../developer_documentation/tangents/">Tangents</a></li><li><a class="tocitem" href="../../developer_documentation/custom_tangent_type/">Writing Custom Tangent Types</a></li><li><a class="tocitem" href="../../developer_documentation/ir_representation/">IR Representations and Code Transformations</a></li><li><a class="tocitem" href="../../developer_documentation/forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/reverse_mode_design/">Reverse-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../../developer_documentation/internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Understanding Mooncake.jl</a></li><li class="is-active"><a href>Towards AD in Julia: Composition of Rules (to-be-updated)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Towards AD in Julia: Composition of Rules (to-be-updated)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl/blob/main/docs/src/understanding_mooncake/what_programme_are_you_differentiating.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Towards-AD-in-Julia:-Composition-of-Rules-(to-be-updated)"><a class="docs-heading-anchor" href="#Towards-AD-in-Julia:-Composition-of-Rules-(to-be-updated)">Towards AD in Julia: Composition of Rules (to-be-updated)</a><a id="Towards-AD-in-Julia:-Composition-of-Rules-(to-be-updated)-1"></a><a class="docs-heading-anchor-permalink" href="#Towards-AD-in-Julia:-Composition-of-Rules-(to-be-updated)" title="Permalink"></a></h1><p>Prerequisites: <a href="../algorithmic_differentiation/#Algorithmic-Differentiation">Algorithmic Differentiation</a>.</p><p>In <a href="../rule_system/#Mooncake.jl&#39;s-Rule-System">Mooncake.jl&#39;s Rule System</a> we discuss a generic mathematical model for a Julia <code>function</code>, and state what a rule to differentiate it in reverse-mode must do. Our goal, however, is to implement an algorithm which produces rules for functions which we do not already have rules for. This section explains the mathematical model required to know how to do this.</p><h2 id="A-Motivating-Example"><a class="docs-heading-anchor" href="#A-Motivating-Example">A Motivating Example</a><a id="A-Motivating-Example-1"></a><a class="docs-heading-anchor-permalink" href="#A-Motivating-Example" title="Permalink"></a></h2><p>By the end of this section we will understand why, for the following function:</p><pre><code class="language-julia hljs">function f(x, y)
    a = g(x)
    b = h(a, y)
    return b
end</code></pre><p>the following rule is a correct implementation of reverse-mode AD for it:</p><pre><code class="language-julia hljs">function r(f, x, y)
    a, adj_g = r(g, x)
    b, adj_h = r(h, a, x, y)
    function adj_f(db)
        _, da, dx, dy = adj_h(db)
        _, dx2 = adj_g(da)
        dx = Mooncake.increment!!(dx, dx2)
        return NoRData(), dx, dy
    end
    return b, adj_f
end</code></pre><p>Observe that the above rule essentially does the following:</p><ol><li>fowards-pass: replace calls to rules.</li><li>reverse-pass: run adjoints in reverse order, adding together rdata when a variable is used multiple times.</li></ol><p>This way of writing rules is the essence of the &quot;A&quot; in &quot;AD&quot;. This page is therefore dedicated to building up to this example via a sequence of increasingly general examples. Once we have this, extending it to a <em>very</em> general class of Julia functions is comparatively straightforward.</p><p>We shall adopt the following approach to each problem:</p><ol><li>specify class of <code>function</code>s,</li><li>specify class of differentiable functions used to model these <code>function</code>s,</li><li>specify how to find the adjoints of this differentiable model, and</li><li>describe a rule system which implements these adjoints.</li></ol><p>At a high level, you can think of this approach as first &quot;mathematising&quot; the problem, applying the techniques developed in <a href="../algorithmic_differentiation/#Algorithmic-Differentiation">Algorithmic Differentiation</a> to determine what it is that AD must do, and then providing an outline for implementing this model as a computer programme.</p><h2 id="Part-1:-Simple-Compositions-of-Pure-Functions"><a class="docs-heading-anchor" href="#Part-1:-Simple-Compositions-of-Pure-Functions">Part 1: Simple Compositions of Pure Functions</a><a id="Part-1:-Simple-Compositions-of-Pure-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Part-1:-Simple-Compositions-of-Pure-Functions" title="Permalink"></a></h2><p>For this class of <code>function</code>s, the translation between the Julia <code>function</code> and differentiable function used to model it is almost trivial. We ask for patience, and promise that the modelling task will become more interesting shortly!</p><h3 id="function-Class"><a class="docs-heading-anchor" href="#function-Class"><code>function</code> Class</a><a id="function-Class-1"></a><a class="docs-heading-anchor-permalink" href="#function-Class" title="Permalink"></a></h3><p>To start with, let us consider only <code>function</code>s which are pure (free of externally-visible side effects, such as the modification of their arguments of global variables), unary (single-argument), and don&#39;t contain any data themselves (e.g. no closures or callable <code>struct</code>s). For example, consider:</p><h4 id="g:"><a class="docs-heading-anchor" href="#g:"><code>g</code>:</a><a id="g:-1"></a><a class="docs-heading-anchor-permalink" href="#g:" title="Permalink"></a></h4><p><code>g(x::Vector{Float64}) = 2x</code> TODO: pick a non-linear example!!!!</p><h4 id="h:"><a class="docs-heading-anchor" href="#h:"><code>h</code>:</a><a id="h:-1"></a><a class="docs-heading-anchor-permalink" href="#h:" title="Permalink"></a></h4><p><code>h(x::Matrix{Float64}) = sum(x)</code>.</p><h4 id="Composition"><a class="docs-heading-anchor" href="#Composition">Composition</a><a id="Composition-1"></a><a class="docs-heading-anchor-permalink" href="#Composition" title="Permalink"></a></h4><p>Let <code>f</code> be the composition of <code>f_1, ..., f_N</code>, a collection of <code>N</code> Julia <code>function</code>s which are pure and unary. This might be implemented as <code>f(x) := f_N ∘ ... ∘ f_1</code>, or perhaps</p><pre><code class="language-julia hljs">function f(x)
    x_1 = x
    x_2 = f_1(x_1)
    ...
    return f_N(x_N)
end</code></pre><p>There are many ways to implement this function.</p><h3 id="Differentiable-Model"><a class="docs-heading-anchor" href="#Differentiable-Model">Differentiable Model</a><a id="Differentiable-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Differentiable-Model" title="Permalink"></a></h3><p>We propose to represent any <code>function</code> <code>f</code> in this class by a differentiable function <span>$f : \mathcal{X} \to \mathcal{Y}$</span>.</p><h4 id="g:-2"><a class="docs-heading-anchor" href="#g:-2"><code>g</code>:</a><a class="docs-heading-anchor-permalink" href="#g:-2" title="Permalink"></a></h4><p>Let <span>$\mathcal{X} = \mathcal{Y} =: \mathbb{R}^D$</span> where <span>$D$</span> is <code>length(x)</code>, and <span>$f(x) := 2x$</span>.</p><h4 id="h:-2"><a class="docs-heading-anchor" href="#h:-2"><code>h</code>:</a><a class="docs-heading-anchor-permalink" href="#h:-2" title="Permalink"></a></h4><p>Let <span>$\mathcal{X} := \mathbb{R}^{P \times Q}$</span>, and <span>$\mathcal{Y} := \mathbb{R}$</span>, where <span>$P$</span> and <span>$Q$</span> are the number of rows and columns in <code>x</code>, and <span>$f(x) := \sum_{p,q} x_{p,q}$</span>.</p><h4 id="Composition:"><a class="docs-heading-anchor" href="#Composition:">Composition:</a><a id="Composition:-1"></a><a class="docs-heading-anchor-permalink" href="#Composition:" title="Permalink"></a></h4><p>Let <span>$f_n : \mathcal{X}_n \to \mathcal{X}_{n+1}$</span> be the differentiable model for <code>f_n</code>. Then the differentiable model <span>$f : \mathcal{X} \to \mathcal{Y}$</span> for <code>f</code> is <span>$f := f_N \circ \dots \circ f_1$</span>, with <span>$\mathcal{X} := \mathcal{X}_1$</span> and <span>$\mathcal{Y} := \mathcal{X}_{N+1}$</span>.</p><h3 id="Adjoints-of-Model"><a class="docs-heading-anchor" href="#Adjoints-of-Model">Adjoints of Model</a><a id="Adjoints-of-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Adjoints-of-Model" title="Permalink"></a></h3><p>You can apply the tools developed in <a href="../algorithmic_differentiation/#Algorithmic-Differentiation">Algorithmic Differentiation</a> to figure out the adjoints of <code>g</code> and <code>h</code>. The adjoint of <code>f</code> is also given there. Let <span>$D f_n [x_n]^\ast$</span> be the adjoint of the derivative of <span>$f_n$</span> at <span>$x_n$</span>, then the adjoint of <span>$f$</span> at <span>$x$</span> is just</p><p class="math-container">\[D f [x]^\ast = D f_1 [x_1]^\ast \circ \dots \circ D f_N [x_N]^\ast.\]</p><h3 id="Rules"><a class="docs-heading-anchor" href="#Rules">Rules</a><a id="Rules-1"></a><a class="docs-heading-anchor-permalink" href="#Rules" title="Permalink"></a></h3><p>For this simple class of functions, a simple rule system will do. We require that a rule for a <code>function</code> with mathematical model <span>$f$</span> accepts the same argument as the original <code>function</code>, and returns a 2-tuple containing</p><ol><li>the result of applying the <code>function</code> to its input, and</li><li>another function which implements<sup class="footnote-reference"><a id="citeref-implementing_mathematics_on_a_computer" href="#footnote-implementing_mathematics_on_a_computer" class="footnote-ref">[implementing_mathematics_on_a_computer]</a><span class="footnote-preview" id="fn-implementing_mathematics_on_a_computer"></span></sup> the adjoint, i.e. <span>$D f [x]^\ast$</span>.</li></ol><p>Given a rule for a <code>function</code> of interest, we simply run the rule, and can then apply the adjoint to any gradient vector of interest.</p><h4 id="g:-3"><a class="docs-heading-anchor" href="#g:-3"><code>g</code>:</a><a class="docs-heading-anchor-permalink" href="#g:-3" title="Permalink"></a></h4><pre><code class="language-julia hljs">function rrule(::typeof(g), x::Vector{Float64})
    g_adjoint(ȳ::Vector{Float64}) = 2ȳ
    return g(x), g_adjoint
end</code></pre><h4 id="h:-3"><a class="docs-heading-anchor" href="#h:-3"><code>h</code>:</a><a class="docs-heading-anchor-permalink" href="#h:-3" title="Permalink"></a></h4><pre><code class="language-julia hljs">function rrule(::typeof(h), x::Matrix{Float64})
    h_adjoint(ȳ::Float64) = fill(ȳ, size(x))
    return h(x), h_adjoint
end</code></pre><h4 id="Composition:-2"><a class="docs-heading-anchor" href="#Composition:-2">Composition:</a><a class="docs-heading-anchor-permalink" href="#Composition:-2" title="Permalink"></a></h4><p>One possible implementation for a rule for the composition of <code>f_1, ..., f_N</code> is</p><pre><code class="language-julia hljs">function rrule(::typeof(f), x)
    x_1 = x
    x_2, f_1_adjoint = rrule(f_1, x_1)
    ...
    y, f_N_adjoint = rrule(f_N, x_N)
    function f_adjoint(ȳ)
        x̄_N = f_N_adjoint(ȳ)
        ...
        x̄_1 = f_1_adjoint(x̄_2)
        x̄ = x̄_1
        return x̄
    end
    return y, f_adjoint
end</code></pre><p>You should convince yourself that this does indeed return a 2-tuple satisfying the specification above.</p><h2 id="Part-2:-Functions-of-Pure-Functions"><a class="docs-heading-anchor" href="#Part-2:-Functions-of-Pure-Functions">Part 2: Functions of Pure Functions</a><a id="Part-2:-Functions-of-Pure-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Part-2:-Functions-of-Pure-Functions" title="Permalink"></a></h2><p>The previous example demonstrated how we might treat a composition of pure <code>function</code>s of a single argument. Here, we extend this to pure <code>function</code>s of multiple arguments.</p><h3 id="Class-of-functions"><a class="docs-heading-anchor" href="#Class-of-functions">Class of <code>function</code>s</a><a id="Class-of-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Class-of-functions" title="Permalink"></a></h3><p>To see an example of this, consider the following computation graph:</p><p><img src="../../assets/computation_graph.png" alt="linear_regression"/></p><p>It describes the loss function associated to linear regression, and might be written as Julia code in the following way:</p><pre><code class="language-julia hljs">function linear_regression_loss(W, X, Y)
    Y_hat = X * W
    eps = Y - Y_hat
    l = dot(eps, eps)
    return l
end</code></pre><p>As before, in order to produce a precise mathematical model for this Julia <code>function</code>, we reduce it to the composition of elementary functions. However, in order to do so, we will have to be a little more creative in how we choose these functions.</p><h3 id="Differentiable-Mathematical-Model"><a class="docs-heading-anchor" href="#Differentiable-Mathematical-Model">Differentiable Mathematical Model</a><a id="Differentiable-Mathematical-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Differentiable-Mathematical-Model" title="Permalink"></a></h3><p>We model this <code>function</code> as a function <span>$f$</span> defined as follows:</p><p class="math-container">\[\begin{align}
    f :=&amp;\, r \circ \varphi_3 \circ \varphi_2 \circ \varphi_1 \textrm{ where } \nonumber \\
    \varphi_1(W, X, Y) :=&amp;\, (W, X, Y, XW) \nonumber \\
    \varphi_2(W, X, Y, \hat{Y}) :=&amp;\, (W, X, Y, \hat{Y}, Y - \hat{Y}) \nonumber \\
    \varphi_3(W, X, Y, \hat{Y}, \varepsilon) :=&amp;\, (W, X, Y, \hat{Y}, \varepsilon, \|\varepsilon\|_2^2) \nonumber \\
    r(W, X, Y, \hat{Y}, \varepsilon, l) :=&amp;\, l \nonumber
\end{align}\]</p><p>In words, our mathematical model for <code>linear_regression_loss</code> is the composition of four differentiable functions. The first three map from a tuple containing all variables seen so far, to a tuple containing the same variables <em>and</em> the value returned by the operation being modeled, and the fourth simple reads off the elements of the final tuple which were passed in as arguments, and the return value.</p><p>In general, we model the <span>$n$</span>th Julia <code>function</code> <em>call</em> with a function <span>$\varphi_n$</span> mapping from a tuple of <span>$D$</span> elements to a tuple of <span>$D + 1$</span> elements, of the form</p><p class="math-container">\[\varphi_n(x) := (x_1, \dots, x_D, g_n (a_n(x)))\]</p><p>for some differentiable function <span>$g_n$</span>, and &quot;argument selector&quot; function <span>$a_n$</span>. In words: each function call involves</p><ol><li>preparing the arguments to be passed to the function call, (<span>$a_n$</span>)</li><li>calling the function (<span>$g_n$</span>), and</li><li>adding a new variable to the list of in-scope variables (new tuple is of length <span>$D + 1$</span>).</li></ol><p>For example, in the case of our example above,</p><p class="math-container">\[\begin{align}
    &amp;\varphi_1:\quad a_1(x) := (x_2, x_1)  &amp;\text{ and   } \quad &amp;g_1(A,B) := AB \nonumber \\
    &amp;\varphi_2:\quad a_2(x) := (x_3, x_4)  &amp;\text{ and   } \quad &amp;g_2(A,B) := A - B \nonumber \\
    &amp;\varphi_3:\quad a_3(x) := x_5         &amp;\text{ and   } \quad &amp;g_3(A) := \|A\|_2^2 \nonumber
\end{align}\]</p><p>Note that the argument to <span>$a_1$</span> is a 3-tuple, to <span>$a_2$</span> a 4-tuple, and to <span>$a_3$</span> a 5-tuple. Crucially, observe that <span>$f$</span> has exactly the same structure as <span>$g_1$</span>, <span>$g_2$</span>, and <span>$g_3$</span> – it maps from the tuple containing its arguments to its <code>return</code> value. This gives us a recursive structure which is essential for making AD work.</p><p><span>$r$</span> always just maps from a tuple to the last element of that tuple.</p><h3 id="Differentiating-the-Mathematical-Model"><a class="docs-heading-anchor" href="#Differentiating-the-Mathematical-Model">Differentiating the Mathematical Model</a><a id="Differentiating-the-Mathematical-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Differentiating-the-Mathematical-Model" title="Permalink"></a></h3><p>Dropping the subscript <span>$n$</span>, functions such as <span>$\varphi$</span> have derivative</p><p class="math-container">\[D [\varphi, x] (\dot{x}) = (\dot{x}_1, \dots, \dot{x}_D, D [g \circ a, x] (\dot{x})).\]</p><p>Letting <span>$\bar{y} := (\bar{y}_1, \dots \bar{y}_{D+1})$</span>, we can perform the usual manipulations to find the adjoint of <span>$D[\varphi, x]$</span>:</p><p class="math-container">\[\begin{align}
    \langle \bar{y}, D[\varphi, x](\dot{x}) \rangle &amp;= \langle (\bar{y}_1, \dots, \bar{y}_{D+1}), (\dot{x}_1, \dots, \dot{x}_D, D[g \circ a, x](\dot{x})) \rangle \nonumber \\
        &amp;= \sum_{d=1}^D \langle \bar{y}_d, \dot{x}_d \rangle + \langle D[g \circ a, x]^\ast (\bar{y}_{D+1}), \dot{x} \rangle \nonumber \\
        &amp;= \langle (\bar{y}_1, \dots, \bar{y}_D), \dot{x} \rangle + \langle D[g \circ a, x]^\ast (\bar{y}_{D+1}), \dot{x} \rangle \nonumber \\
        &amp;= \langle (\bar{y}_1, \dots, \bar{y}_D) + D[g \circ a, x]^\ast (\bar{y}_{D+1}), \dot{x} \rangle. \nonumber
\end{align}\]</p><p>So, what is <span>$D[g \circ a, x]^\ast (\bar{y}_{D+1})$</span>?. First let <span>$z := a(x)$</span> and observe that <span>$D[a, x] = a$</span> since <span>$a$</span> is linear. It follows that</p><p class="math-container">\[D[g \circ a, x]^\ast = (D[g, z] \circ D[a, x])^\ast = (D[g, z] \circ a)^\ast = a^\ast \circ D[g, z]^\ast .\]</p><p>Since <span>$g$</span> has the same form as <span>$f$</span>, assume that we know <span>$D[g, z]^\ast$</span> by induction. An expression for <span>$a^\ast$</span>, on the other hand, we obtain from its definition directly.</p><p>As discussed <span>$a$</span> maps from a tuple containing all variables passed in to <span>$f$</span>, to the tuple which is to be passed to <span>$g$</span>. For example, suppose variables <code>x_1, x_2, x_3</code> are in-scope, then a call of the form</p><ol><li><code>g(x_2, x_1)</code> has argument selector <span>$a(x) := (x_2, x_1)$</span>, and</li><li><code>g(x_3, x_3)</code> has argument selector <span>$a(x) := (x_3, x_3)$</span>,</li></ol><p>where <span>$x$</span> is a 3-tuple in both examples. The general form of an argument selector <span>$a$</span> mapping from a <span>$D$</span>-tuple to an <span>$N$</span>-tuple is</p><p class="math-container">\[a(x) = (x_{i_1}, \dots, x_{i_N})\]</p><p>for some set of integers <span>$i_1, \dots, i_N \in \{1, \dots, D\}$</span>. Let <span>$z = (z_1, \dots, z_N)$</span>, and <span>$c_n(z)$</span> the <span>$D$</span>-tuple which is equal to <span>$z_n$</span> at element <span>$i_n$</span>, and zero everywhere else. Then adjoint of <span>$a$</span> is obtained in the usual manner:</p><p class="math-container">\[\begin{align}
\langle z, a^\ast (x) \rangle &amp;= \langle (z_1, \dots, z_N), (x_{i_1}, \dots, x_{i_N}) \rangle = \sum_{n=1}^N \langle z_n, x_{i_n} \rangle = \sum_{n=1}^N \langle c_n(z), x \rangle = \langle \sum_{n=1}^N c_n(z), x \rangle, \nonumber
\end{align}\]</p><p>from which we conclude</p><p class="math-container">\[a^\ast(z) = \sum_{n=1}^N c_n(z). \nonumber\]</p><p>Applying this result to our previous examples, we see that</p><ol><li>when <span>$a(x) := (x_2, x_1)$</span>, <span>$a^\ast (z) := (z_2, z_1, 0)$</span>, and that</li><li>when <span>$a(x) := (x_3, x_3)$</span>, <span>$a^\ast (z) := (0, 0, z_1 + z_2)$</span>.</li></ol><p>Combining this result with the adjoint of the derivative of <span>$\varphi$</span> yields</p><p class="math-container">\[D[\varphi, x]^\ast (\bar{y}) = (\bar{y}_1, \dots, \bar{y}_D) + \sum_{n=1}^N c_n(D [g, z]^\ast (\bar{y})).\]</p><p>We must also find the derivative of the adjoint of <span>$r$</span>. It is linear, so it is its own derivative. Assume <span>$f$</span> is of the form</p><p class="math-container">\[f = r \circ \varphi_P \circ \dots \circ \varphi_1\]</p><p>and that its arguments are <span>$N$</span>-tuples. Then <span>$r$</span> maps from <span>$(N + P)$</span>-tuples to a single value, and its adjoint is a tuple of length <span>$N + P$</span> given by</p><p class="math-container">\[r^\ast(\bar{y}) = (0, \dots, 0, \bar{y}_{N+1}).\]</p><p>Finally, the adjoint the derivative of <span>$f$</span> is</p><p class="math-container">\[D [f,x]^\ast = D[\varphi_1, x_1]^\ast \circ \dots \circ D [\varphi_P, x_P]^\ast \circ r^\ast\]</p><p>where <span>$x_p := \varphi_{p-1}(x_{p-1})$</span> and <span>$x_1 := x$</span>. Since we now have expressions for all of the terms in this, we consider how to produce a programme which implements this adjoint.</p><h3 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h3><p>We start by revisiting our Julia <code>function</code> which computes the loss associated to linear regression, as it is easiest to start with a concrete example:</p><pre><code class="language-julia hljs">function f(W, X, Y)
    Y_hat = X * W
    eps = Y - Y_hat
    l = dot(eps, eps)
    return l
end</code></pre><p>Let the function <code>rule</code> map from a <code>function</code> and its arguments to a 2-tuple comprising the return value of that function, and a closure which computes the adjoint. The closure maps from a gradient vector, associated to the return value of the function, to a tuple containing the gradient vectors associated to each of the arguments to the function.</p><p>Assume that we have methods of <code>rule</code> for <code>*</code>, <code>-</code>, and <code>dot</code>, then a possible implementation of <code>rule</code> for <code>f</code> is</p><pre><code class="language-julia hljs">function rule(f, W, X, Y)
    Y_hat, adjoint_mul = rule(*, X, W)
    eps, adjoint_minus = rule(-, Y, Y_hat)
    l, adjoint_dot = rule(dot, eps, eps)
    function adjoint_f(dout)

        # Implement adjoint of r. Assume that we have a way to produce zero gradients.
        dl = dout
        deps = zero_gradient(eps)
        dY_hat = zero_gradient(Y_hat)
        dY = zero_gradient(Y)
        dX = zero_gradient(X)
        dW = zero_gradient(W)

        # Run adjoint of `dot`.
        (deps_inc_1, deps_inc_2) = adjoint_dot(dl)

        # Run adjoint of argument selector for the call to `dot`.
        # Observe that the gradient w.r.t. `eps` gets incremented twice, because `eps`
        # appears twice in the argument list to `dot`. This is consistent with the
        # argument selector adjoint.
        deps = deps + deps_inc_1
        deps = deps + deps_inc_2

        # Run adjoint of `-`.
        (dY_inc, dY_hat_inc) = adjoint_minus(deps)
    
        # Run adjoint of argument selector for the call to `-`.
        dY = dY + dY_inc
        dY_hat = dY_hat + dY_hat_inc

        # Run adjoint of `*`.
        (dX_inc, dW_inc) = adjoint_mul(dY_hat)

        # Run adjoint of argument selector for the call to `*`.
        dX = dX + dX_inc
        dW = dW + dW_inc

        # Return the gradients w.r.t. the arguments.
        return dW, dX, dY
    end
    return l, adjoint_f
end</code></pre><p>At a high-level, rule derivation in the general case proceeds as follows. First, replace all calls in the original function with calls to <code>rule</code>s. Then define a closure which accepts a single argument. This closure first implements the adjoint of <span>$r$</span>, by assigning the argument to the closure to be the gradient of the primal <code>return</code> value, and setting the gradient of all other variables to zero. Subsequently, for each call in the primal function, in reverse order, apply the adjoint returned by the associated rule, and apply the adjoint of the argument selector associated to the call by incrementing the value of the gradients of its arguments. Finally, return a tuple containing the gradients w.r.t. each of the arguments to the primal function.</p><p>There are other equivalent ways to implement the above – see e.g. <a href="#Zygote-Implementation">Zygote Implementation</a> below. If nothing else, the derivations in this section provide a clear route to explain what goes on there.</p><p>At this point, we have enough to understand the bulk of many AD systems. If you squint, the above provides a good starting point from which to understand what <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a>, <a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a>, <a href="https://pytorch.org">PyTorch</a>, and <a href="https://github.com/jax-ml/jax">JAX</a> do, albeit each of these systems has their own particular way of achieving the above (JAX in particular). The defining property of each of these systems is that they (for the most part) involve pure-functions.</p><h2 id="Part-3:-Applying-Sequences-of-Mutating-Functions"><a class="docs-heading-anchor" href="#Part-3:-Applying-Sequences-of-Mutating-Functions">Part 3: Applying Sequences of Mutating Functions</a><a id="Part-3:-Applying-Sequences-of-Mutating-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Part-3:-Applying-Sequences-of-Mutating-Functions" title="Permalink"></a></h2><p>Julia <code>function</code> can modify their inputs. For example, consider</p><pre><code class="language-julia hljs">function square!(x::Vector{Float64})
    x .= x .^ 2
    return nothing
end</code></pre><p>This <code>function</code> mutates (modifies / changes) the values stored in each element of <code>x</code>. In order to model this kind of behaviour, we introduce the notion of state, as discussed in <a href="../rule_system/#Mooncake.jl&#39;s-Rule-System">Mooncake.jl&#39;s Rule System</a>. In general, we associate to a Julia <code>function</code> <code>f!</code> a differentiable function <span>$f : \mathcal{X} \to \mathcal{X}$</span>, defined such that if <code>x</code> is associated to value <span>$x$</span> prior to running <code>f!</code>, it has value <span>$f(x)$</span> after running <code>f!</code>. We call <span>$f$</span> the <em>transition</em> <em>function</em> associated to <code>f!</code>. In the case of <code>square!</code>, the transition function is <span>$f(x) = x \odot x$</span>.</p><p>We first study <code>function</code>s of the following form:</p><pre><code class="language-julia hljs">function f!(x::Vector{Float64})
    f_1!(x)
    f_2!(x)
    ...
    f_N!(x)
    return nothing
end</code></pre><p>We associate to each <code>f_n!</code> its transition function <span>$f_n : \mathcal{X} \to \mathcal{X}$</span>, where <span>$\mathcal{X} := \mathbb{R}^D$</span> (assume for now that the <code>length(x)</code> is not modified by any of the operations). The transition function <span>$f : \mathcal{X} \to \mathcal{X}$</span> associated to <code>f!</code> is simply</p><p class="math-container">\[f := f_N \circ \dots \circ f_1\]</p><p>Therefore the adjoint of the derivative is</p><p class="math-container">\[D[f, x]^\ast = D[f_1, x_1]^\ast \circ \dots \circ D[f_N, x_N]^\ast,\]</p><p>where <span>$x_{n+1} := f_n(x_n)$</span> and <span>$x_1 := x$</span> as usual. How might we implement this? The crucial difference from before is that we lose access to some (or perhaps all) of e.g. <span>$x_n$</span> when we apply <code>f_n!</code> to put <code>x</code> into the state with value <span>$x_{n+1}$</span>. This is important in the case of <code>square!</code>. To see this, first note that the derivative of its transition function is <span>$D[f, x](\dot{x}) = 2 x \odot \dot{x}$</span>, with corresponding adjoint <span>$D[f, x]^\ast(\bar{y}) = 2 \bar{y} \odot x$</span>. The fact that <span>$x$</span> appears in the adjoint expression means that we need access to the value that the programme variable <code>x</code> takes <em>before</em> running <code>square!</code>, but this is overwritten when we run <code>square!</code>. The same consideration applies to each <code>f_n</code> in <code>f!</code> – if the adjoints of their transition functions involve <span>$x$</span>, we need access to the value that <code>x</code> took at the point just before running <code>f_n!</code>.</p><p>We can solve this problem by insisting that the reverse-pass of a rule for a <code>function</code> return its arguments to the state that they were in prior to running the <code>function</code>, thus granting rules license to safely assume that all state is &quot;as they left it&quot; from the forwards-pass.</p><p>Under this framework, a rule for <code>square!</code> might be something like</p><pre><code class="language-julia hljs">function rule(::typeof(square!), x::CoDual{Vector{Float64}})
    # Save current value of `x` for use in the reverse-pass.
    x_copy = copy(primal(x))

    # Run primal operation.
    square!(x)

    # On entry, x̄ is the gradient associated to the value of `x` after running `square!`.
    function square!_reverse()

        # Reset `x` to have the value it took before running the forwards pass.
        primal(x) .= x_copy

        # Modify gradient to correspond to result of adjoint of transition function.
        tangent(x) .= 2 .* primal(x)

        return nothing
    end

    return nothing, square!_reverse
end</code></pre><p>where <code>CoDual{Vector{Float64}}</code> is a <code>struct</code> containing the value associated to <code>x</code>, retrieved using <code>primal(x)</code>, and memory into which its gradients can be written, retrieved using <code>tangent(x)</code>. It has value equal to the input to the transition function before running the reverse-pass, and value equal to the application of the adjoint to this input after running the reverse-pass.</p><p>So to use the above <code>rule</code> to compute the adjoint of the transition function associated to <code>square!</code>, you might do the following:</p><ol><li>initialise <code>x = CoDual(x, zeros(x))</code>,</li><li>compute <code>_, square!_reverse = rule(square!, x)</code>,</li><li>set <code>tangent(x)</code> equal to the gradient you wish to use as the input to the adjoint of the transition function associated to <code>square!</code>,</li><li>run <code>square!_reverse</code>, and</li><li>retrieve the gradient <code>tangent(x)</code>.</li></ol><p>Notice that this has a distinctly different style to before. The forwards-pass happens through mutation of the argument <code>x</code>, and the reverse-pass happens entirely as a side-effect of running the closure <code>square!_reverse</code>.</p><p>Similarly, we can implement a rule for <code>f!</code> as follows:</p><pre><code class="language-julia hljs">function rule(::typeof(f!), x::CoDual{Vector{Float64}})

    # Run forwards-pass.
    _, f_1!_reverse = rule(f_1!, x)
    _, f_2!_reverse = rule(f_2!, x)
    ...
    _, f_N!_reverse = rule(f_N!, x)

    # Define reverse-pass -- just run all rules in reverse.
    function f!_reverse()
        f_N!_reverse()
        ...
        f_2!_reverse()
        f_1!_reverse()
        return nothing
    end

    # Return nothing, and the new rule.
    return nothing, f!_reverse
end</code></pre><p>This rule satisfies our requirement that all modifications to <code>x</code> are un-done by <code>f!_reverse</code> inductively – we assume that each <code>f_n!_reverse</code> satisfies this require.</p><h2 id="Part-4:-Computational-Graphs-of-Mutating-Functions"><a class="docs-heading-anchor" href="#Part-4:-Computational-Graphs-of-Mutating-Functions">Part 4: Computational Graphs of Mutating Functions</a><a id="Part-4:-Computational-Graphs-of-Mutating-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Part-4:-Computational-Graphs-of-Mutating-Functions" title="Permalink"></a></h2><h2 id="Part-5:-Computational-Graphs-of-Mutating-Functions-with-Aliasing"><a class="docs-heading-anchor" href="#Part-5:-Computational-Graphs-of-Mutating-Functions-with-Aliasing">Part 5: Computational Graphs of Mutating Functions with Aliasing</a><a id="Part-5:-Computational-Graphs-of-Mutating-Functions-with-Aliasing-1"></a><a class="docs-heading-anchor-permalink" href="#Part-5:-Computational-Graphs-of-Mutating-Functions-with-Aliasing" title="Permalink"></a></h2><h3 id="Zygote-Implementation"><a class="docs-heading-anchor" href="#Zygote-Implementation">Zygote Implementation</a><a id="Zygote-Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Zygote-Implementation" title="Permalink"></a></h3><p>For example, rather than incrementing gradients immediately after calls to adjoints, <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a> adds together the gradients of a variable immediately before the gradient is used. The implementation of adjoint produced by Zygote is, roughly speaking, something like</p><pre><code class="language-julia hljs">function rule(f, W, X, Y)
    Y_hat, adjoint_mul = rule(*, X, W)
    eps, adjoint_minus = rule(-, Y, Y_hat)
    l, adjoint_dot = rule(dot, eps, eps)
    function adjoint_f(dout)

        # Implement adjoint of r. Assume that we have a way to produce zero gradients.
        dl = dout

        # Run adjoint of `dot`.
        (deps_1, deps_2) = adjoint_dot(dl)

        # Run adjoint of `-`.
        deps = deps_1 + deps_2
        (dY, dY_hat) = adjoint_minus(deps)
    
        # Run adjoint of `*`.
        (dX, dW) = adjoint_mul(dY_hat)

        # Return the gradients w.r.t. the arguments.
        return dW, dX, dY
    end
    return l, adjoint_f
end</code></pre><p>It computes the same thing as discussed previously, but avoids redundant calls to <code>zero_gradient</code> and <code>+</code>.</p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-implementing_mathematics_on_a_computer"><a class="tag is-link" href="#citeref-implementing_mathematics_on_a_computer">implementing_mathematics_on_a_computer</a>put differently, suppose that someone wrote down some equations in a paper or textbook, and gave you a piece of code which they claim is an implementation of these equations (e.g. a neural network, a probabilistic model, an ODE, etc). Under what conditions would you be satisfied that the implementation was correct? We all do this in informal ways all of the time. I propose that you apply the same set of standards here: we have written down some equations for the adjoints, and are claiming that our rule system is an implementation of these. The fact that we arrived at this set of equations by modelling a computer programme is neither here nor there for this step of the process.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../rule_system/">« Mooncake.jl&#39;s Rule System</a><a class="docs-footer-nextpage" href="../../utilities/defining_rules/">Defining Rules »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Tuesday 23 December 2025 17:55">Tuesday 23 December 2025</span>. Using Julia version 1.11.8.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
