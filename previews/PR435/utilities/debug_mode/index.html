<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Debug Mode · Mooncake.jl</title><meta name="title" content="Debug Mode · Mooncake.jl"/><meta property="og:title" content="Debug Mode · Mooncake.jl"/><meta property="twitter:title" content="Debug Mode · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../defining_rules/">Defining Rules</a></li><li class="is-active"><a class="tocitem" href>Debug Mode</a></li><li><a class="tocitem" href="../debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../../developer_documentation/running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../../developer_documentation/developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../../developer_documentation/forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Utilities</a></li><li class="is-active"><a href>Debug Mode</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Debug Mode</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl/blob/main/docs/src/utilities/debug_mode.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Debug-Mode"><a class="docs-heading-anchor" href="#Debug-Mode">Debug Mode</a><a id="Debug-Mode-1"></a><a class="docs-heading-anchor-permalink" href="#Debug-Mode" title="Permalink"></a></h1><p><em><strong>The Problem</strong></em></p><p>A major source of potential problems in AD systems is rules returning the wrong type of tangent / fdata / rdata for a given primal value. For example, if someone writes a rule like</p><pre><code class="language-julia hljs">function rrule!!(::CoDual{typeof(+)}, x::CoDual{&lt;:Real}, y::CoDual{&lt;:Real})
    plus_reverse_pass(dz::Real) = NoRData(), dz, dz
    return zero_fcodual(primal(x) + primal(y))
end</code></pre><p>and calls</p><pre><code class="language-julia hljs">rrule(zero_fcodual(+), zero_fcodual(5.0), zero_fcodual(4f0))</code></pre><p>then the type of <code>dz</code> on the reverse pass will be <code>Float64</code> (assuming everything happens correctly), and this rule will return a <code>Float64</code> as the rdata for <code>y</code>. However, the primal value of <code>y</code> is a <code>Float32</code>, and <code>rdata_type(Float32)</code> is <code>Float32</code>, so returning a <code>Float64</code> is incorrect. This error might cause the reverse pass to fail loudly immediately, but it might also fail silently. It might cause an error much later in the reverse pass, making it hard to determine that the source of the error was the above rule. Worst of all, in some cases it could plausibly cause a segfault, which is more-or-less the worst kind of outcome possible.</p><p><em><strong>The Solution</strong></em></p><p>Check that the types of the fdata / rdata associated to arguments are exactly what <code>tangent_type</code> / <code>fdata_type</code> / <code>rdata_type</code> require upon entry to / exit from rules and pullbacks.</p><p>This is implemented via <code>DebugRRule</code>:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DebugRRule" href="#Mooncake.DebugRRule"><code>Mooncake.DebugRRule</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">DebugRRule(rule)</code></pre><p>Construct a callable which is equivalent to <code>rule</code>, but inserts additional type checking. In particular:</p><ul><li>check that the fdata in each argument is of the correct type for the primal</li><li>check that the fdata in the <code>CoDual</code> returned from the rule is of the correct type for the   primal.</li></ul><p>This happens recursively. For example, each element of a <code>Vector{Any}</code> is compared against each element of the associated fdata to ensure that its type is correct, as this cannot be guaranteed from the static type alone.</p><p>Some additional dynamic checks are also performed (e.g. that an fdata array of the same size as its primal).</p><p>Let <code>rule</code> return <code>y, pb!!</code>, then <code>DebugRRule(rule)</code> returns <code>y, DebugPullback(pb!!)</code>. <code>DebugPullback</code> inserts the same kind of checks as <code>DebugRRule</code>, but on the reverse-pass. See the docstring for details.</p><p><em>Note:</em> at any given point in time, the checks performed by this function constitute a necessary but insufficient set of conditions to ensure correctness. If you find that an error isn&#39;t being caught by these tests, but you believe it ought to be, please open an issue or (better still) a PR.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/60aefbf2134e9b96399623535a798cb0bca69dc5/src/debug_mode.jl#L49-L74">source</a></section></article><p>You can straightforwardly enable it when building a rule via the <code>debug_mode</code> kwarg in the following:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.build_rrule" href="#Mooncake.build_rrule"><code>Mooncake.build_rrule</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_rrule(args...; debug_mode=false)</code></pre><p>Helper method. Only uses static information from <code>args</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/60aefbf2134e9b96399623535a798cb0bca69dc5/src/interpreter/s2s_reverse_mode_ad.jl#L1008-L1012">source</a></section><section><div><pre><code class="language-julia hljs">build_rrule(sig::Type{&lt;:Tuple})</code></pre><p>Equivalent to <code>build_rrule(Mooncake.get_interpreter(), sig)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/60aefbf2134e9b96399623535a798cb0bca69dc5/src/interpreter/s2s_reverse_mode_ad.jl#L1018-L1022">source</a></section><section><div><pre><code class="language-julia hljs">build_rrule(interp::MooncakeInterpreter{C}, sig_or_mi; debug_mode=false) where {C}</code></pre><p>Returns a <code>DerivedRule</code> which is an <code>rrule!!</code> for <code>sig_or_mi</code> in context <code>C</code>. See the docstring for <code>rrule!!</code> for more info.</p><p>If <code>debug_mode</code> is <code>true</code>, then all calls to rules are replaced with calls to <code>DebugRRule</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/60aefbf2134e9b96399623535a798cb0bca69dc5/src/interpreter/s2s_reverse_mode_ad.jl#L1038-L1045">source</a></section></article><p>When using ADTypes.jl, you can choose whether or not to use it via the <code>debug_mode</code> kwarg:</p><pre><code class="language-julia-repl hljs">julia&gt; AutoMooncake(; config=Mooncake.Config(; debug_mode=true))
AutoMooncake{Mooncake.Config}(Mooncake.Config(true, false))</code></pre><h3 id="When-Should-You-Use-Debug-Mode?"><a class="docs-heading-anchor" href="#When-Should-You-Use-Debug-Mode?">When Should You Use Debug Mode?</a><a id="When-Should-You-Use-Debug-Mode?-1"></a><a class="docs-heading-anchor-permalink" href="#When-Should-You-Use-Debug-Mode?" title="Permalink"></a></h3><p>Only use <code>debug_mode</code> when debugging a problem. This is because is has substantial performance implications.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../defining_rules/">« Defining Rules</a><a class="docs-footer-nextpage" href="../debugging_and_mwes/">Debugging and MWEs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 8 January 2025 18:33">Wednesday 8 January 2025</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
