<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Safe Mode · Tapir.jl</title><meta name="title" content="Safe Mode · Tapir.jl"/><meta property="og:title" content="Safe Mode · Tapir.jl"/><meta property="twitter:title" content="Safe Mode · Tapir.jl"/><meta name="description" content="Documentation for Tapir.jl."/><meta property="og:description" content="Documentation for Tapir.jl."/><meta property="twitter:description" content="Documentation for Tapir.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Tapir.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Tapir.jl</a></li><li><span class="tocitem">Understanding Tapir.jl</span><ul><li><a class="tocitem" href="../understanding_intro/">Introduction</a></li><li><a class="tocitem" href="../algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../mathematical_interpretation/">Tapir.jl&#39;s Rule System</a></li></ul></li><li><a class="tocitem" href="../known_limitations/">Known Limitations</a></li><li class="is-active"><a class="tocitem" href>Safe Mode</a></li><li><a class="tocitem" href="../debugging_and_mwes/">Debugging and MWEs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Safe Mode</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Safe Mode</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Tapir.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Tapir.jl/blob/main/docs/src/safe_mode.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Safe-Mode"><a class="docs-heading-anchor" href="#Safe-Mode">Safe Mode</a><a id="Safe-Mode-1"></a><a class="docs-heading-anchor-permalink" href="#Safe-Mode" title="Permalink"></a></h1><p><em><strong>The Problem</strong></em></p><p>A major source of potential problems in AD systems is rules returning the wrong type of tangent / fdata / rdata for a given primal value. For example, if someone writes a rule like</p><pre><code class="language-julia hljs">function rrule!!(::CoDual{typeof(+)}, x::CoDual{&lt;:Real}, y::CoDual{&lt;:Real})
    plus_reverse_pass(dz::Real) = NoRData(), dz, dz
    return zero_fcodual(primal(x) + primal(y))
end</code></pre><p>and calls</p><pre><code class="language-julia hljs">rrule(zero_fcodual(+), zero_fcodual(5.0), zero_fcodual(4f0))</code></pre><p>then the type of <code>dz</code> on the reverse pass will be <code>Float64</code> (assuming everything happens correctly), and this rule will return a <code>Float64</code> as the rdata for <code>y</code>. However, the primal value of <code>y</code> is a <code>Float32</code>, so the appropriate tangent type is also <code>Float32</code>. This error may causes the reverse pass to fail loudly, but it may fail silently. It may cause an error much later in the reverse pass, making it hard to determine that the source of the error was the above rule. Worst of all, in some cases it could plausibly cause a segfault, which is more-or-less the worst kind of outcome possible.</p><p><em><strong>The Solution</strong></em></p><p>Check that the types of the fdata / rdata associated to arguments are exactly what <code>tangent_type</code> / <code>fdata_type</code> / <code>rdata_type</code> require upon entry to / exit from rules and pullbacks.</p><p>This is implemented via <code>SafeRRule</code>:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Tapir.SafeRRule" href="#Tapir.SafeRRule"><code>Tapir.SafeRRule</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">SafeRRule(rule)</code></pre><p>Construct a callable which is equivalent to <code>rule</code>, but inserts additional type checking. In particular:</p><ul><li>check that the fdata in each argument is of the correct type for the primal</li><li>check that the fdata in the <code>CoDual</code> returned from the rule is of the correct type for the   primal.</li></ul><p>This happens recursively. For example, each element of a <code>Vector{Any}</code> is compared against each element of the associated fdata to ensure that its type is correct, as this cannot be guaranteed from the static type alone.</p><p>Some additional dynamic checks are also performed (e.g. that an fdata array of the same size as its primal).</p><p>Let <code>rule</code> return <code>y, pb!!</code>, then <code>SafeRRule(rule)</code> returns <code>y, SafePullback(pb!!)</code>. <code>SafePullback</code> inserts the same kind of checks as <code>SafeRRule</code>, but on the reverse-pass. See the docstring for details.</p><p><em>Note:</em> at any given point in time, the checks performed by this function constitute a necessary but insufficient set of conditions to ensure correctness. If you find that an error isn&#39;t being caught by these tests, but you believe it ought to be, please open an issue or (better still) a PR.</p><p><em>Note:</em> this is a &quot;safe mode&quot; in the sense of operating systems. See e.g. this Wikipedia article: https://en.wikipedia.org/wiki/Safe_mode . Its purpose is to help with debugging, and should not be used when trying to differentiate code in general, as it decreases performance quite substantially in many cases.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Tapir.jl/blob/eb4f54c228370326856dbb3582409f6186dd99ee/src/safe_mode.jl#L49-L79">source</a></section></article><p>You can straightforwardly enable it when building a rule via the <code>safety_on</code> kwarg in the following:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Tapir.build_rrule" href="#Tapir.build_rrule"><code>Tapir.build_rrule</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_rrule(args...; safety_on=false)</code></pre><p>Helper method. Only uses static information from <code>args</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Tapir.jl/blob/eb4f54c228370326856dbb3582409f6186dd99ee/src/interpreter/s2s_reverse_mode_ad.jl#L822-L826">source</a></section><section><div><pre><code class="language-julia hljs">build_rrule(interp::TapirInterpreter{C}, sig_or_mi; safety_on=false) where {C}</code></pre><p>Returns a <code>DerivedRule</code> which is an <code>rrule!!</code> for <code>sig_or_mi</code> in context <code>C</code>. See the docstring for <code>rrule!!</code> for more info.</p><p>If <code>safety_on</code> is <code>true</code>, then all calls to rules are replaced with calls to <code>SafeRRule</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Tapir.jl/blob/eb4f54c228370326856dbb3582409f6186dd99ee/src/interpreter/s2s_reverse_mode_ad.jl#L834-L841">source</a></section></article><p>When using ADTypes.jl, you can choose whether or not to use it via the <code>safe_mode</code> kwarg:</p><pre><code class="language-julia-repl hljs">julia&gt; AutoTapir(safe_mode=false)
AutoTapir(safe_mode=false)</code></pre><h3 id="When-Should-You-Use-Safe-Mode?"><a class="docs-heading-anchor" href="#When-Should-You-Use-Safe-Mode?">When Should You Use Safe Mode?</a><a id="When-Should-You-Use-Safe-Mode?-1"></a><a class="docs-heading-anchor-permalink" href="#When-Should-You-Use-Safe-Mode?" title="Permalink"></a></h3><p>Only use <code>safe_mode</code> when debugging a problem. This is because is has substantial performance implications.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../known_limitations/">« Known Limitations</a><a class="docs-footer-nextpage" href="../debugging_and_mwes/">Debugging and MWEs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 17 September 2024 13:06">Tuesday 17 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
